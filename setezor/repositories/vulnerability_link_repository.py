from setezor.models import VulnerabilityLink, Vulnerability, L4SoftwareVulnerability, L4Software
from setezor.repositories import SQLAlchemyRepository
from sqlmodel import select

class VulnerabilityLinkRepository(SQLAlchemyRepository[VulnerabilityLink]):
    model = VulnerabilityLink

    async def exists(self, vulnerability_link_obj: VulnerabilityLink):
        return False


    async def all_on_l4(self, project_id: str, l4_id: str):
        stmt = select(Vulnerability.id, VulnerabilityLink.link).select_from(L4Software)\
                .join(L4SoftwareVulnerability, L4SoftwareVulnerability.l4_software_id == L4Software.id)\
                .join(Vulnerability, Vulnerability.id == L4SoftwareVulnerability.vulnerability_id)\
                .join(VulnerabilityLink, VulnerabilityLink.vulnerability_id == Vulnerability.id)\
                .filter(L4Software.project_id ==  project_id, L4Software.l4_id == l4_id)
        res = await self._session.exec(stmt)
        return res.all()
    
    async def get_by_port_ids(self, project_id: str, scans: list[str], port_ids: list[int]) -> dict:
        """
        Получает ссылки для множественных портов одним запросом
        Возвращает словарь: {port_id: [links]}
        """
        if not port_ids:
            return 0, {}
        
        stmt = select(
            L4Software.l4_id.label('port_id'),
            VulnerabilityLink.link
        ).select_from(L4Software)\
        .join(L4SoftwareVulnerability, L4SoftwareVulnerability.l4_software_id == L4Software.id)\
        .join(Vulnerability, L4SoftwareVulnerability.vulnerability_id == Vulnerability.id)\
        .join(VulnerabilityLink, VulnerabilityLink.vulnerability_id == Vulnerability.id)\
        .filter(
            VulnerabilityLink.project_id == project_id,
            VulnerabilityLink.scan_id.in_(scans),
            L4Software.l4_id.in_(port_ids)
        )
        
        result = await self._session.exec(stmt)
        rows = result.all()
        links_by_port = {}
        for row in rows:
            port_id = row.port_id
            link = row.link
            if port_id not in links_by_port:
                links_by_port[port_id] = []
            links_by_port[port_id].append(link)

        return links_by_port
