{% import 'modals/tools_modal_constructor.html' as modal %}

{{ modal.create_modal('whoisModalWindow', 'Whois Tool', 'https://help.setezor.net/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B.html#whois') }}

<script>
// IPv4 validation helper
function isIPv4(str) {
  if (!str) return false;
  const blocks = str.split('.');
  if (blocks.length !== 4) return false;
  return blocks.every(block => {
    const num = parseInt(block, 10);
    return !isNaN(num) && num >= 0 && num <= 255 && String(num) === block;
  });
}

const WhoisUI = {
  getStyles() {
    return `
      <style>
        .whois-tool-section {
          background: #f8f9fa;
          border-radius: 8px;
          padding: 12px;
          margin-bottom: 15px;
          border: 1px solid #e9ecef;
        }
        .whois-tool-section h6 {
          font-size: 0.85rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #6c757d;
          margin-bottom: 10px;
          font-weight: bold;
          display: flex;
          align-items: center;
        }
        .whois-tool-section h6 i { 
          margin-right: 8px; 
        }
        .whois-type-tabs {
          margin-bottom: 15px;
        }
      </style>
    `;
  },

  buildParams(prefix) {
    return this.getStyles();
  },

  buildCustomTabs(prefix) {
    return `
      <div class="whois-type-tabs">
        <ul class="nav nav-tabs" id="${prefix}typeTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" 
                    id="${prefix}domains-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#${prefix}domains-mode" 
                    type="button" 
                    role="tab">
              ${i18next.t('Domains')}
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" 
                    id="${prefix}ips-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#${prefix}ips-mode" 
                    type="button" 
                    role="tab">
              ${i18next.t('IPs')}
            </button>
          </li>
        </ul>
      </div>
    `;
  }
};

const WhoisHandlers = {
  isValidDomain(str) {
    if (!str || isIPv4(str)) return false;
    return str.includes('.') && !str.includes(' ') && str.length <= 253;
  },

  handleNodeModal(instance, value) {
    instance.reset();
    const prefix = instance.prefix;
    
    setTimeout(() => {
      if (isIPv4(value)) {
        const ipsTab = document.getElementById(`${prefix}ips-tab`);
        if (ipsTab) ipsTab.click();
        
        const ipInput = document.getElementById(`${prefix}ips_inputIP`);
        if (ipInput) ipInput.value = value;
      } else {
        const domainsTab = document.getElementById(`${prefix}domains-tab`);
        if (domainsTab) domainsTab.click();
        
        const domainInput = document.getElementById(`${prefix}domains_inputDomain`);
        if (domainInput) domainInput.value = value;
      }
    }, 150);
    
    window[`show_${instance.modalId}`]();
  },

  handlePrefill(instance, rows = [], prefillParams = {}) {
    instance.reset();
    const prefix = instance.prefix;
    
    const domains = new Set();
    const ips = new Set();
    
    if (Array.isArray(rows)) {
      rows.forEach(row => {
        if (row.domain && this.isValidDomain(row.domain)) {
          domains.add(row.domain.trim());
        }
        if (row.ipaddr && isIPv4(row.ipaddr)) {
          ips.add(row.ipaddr.trim());
        }
        if (row.ip && isIPv4(row.ip)) {
          ips.add(row.ip.trim());
        }
      });
    }

    if (prefillParams?.targets && Array.isArray(prefillParams.targets)) {
      prefillParams.targets.forEach(target => {
        const t = String(target).trim();
        if (isIPv4(t)) {
          ips.add(t);
        } else if (this.isValidDomain(t)) {
          domains.add(t);
        }
      });
    }

    if (prefillParams?.target) {
      const t = String(prefillParams.target).trim();
      if (isIPv4(t)) {
        ips.add(t);
      } else if (this.isValidDomain(t)) {
        domains.add(t);
      }
    }

    // Fill domains
    if (domains.size > 0) {
      const domainsTab = document.getElementById(`${prefix}domains-tab`);
      if (domainsTab) domainsTab.click();
      
      const domainsArray = Array.from(domains);
      const domainInput = document.getElementById(`${prefix}domains_inputDomain`);
      
      if (domainInput) {
        domainInput.value = domainsArray[0];
        
        for (let i = 1; i < domainsArray.length; i++) {
          instance.addInputField('domain_only', 'domains');
          
          setTimeout(() => {
            const container = document.getElementById(`${prefix}domainsInputContainer`);
            const lastGroup = container?.lastElementChild;
            if (lastGroup) {
              const input = lastGroup.querySelector('.domain');
              if (input) input.value = domainsArray[i];
            }
          }, i * 50);
        }
      }
    }

    // Fill IPs
    if (ips.size > 0) {
      const ipsTab = document.getElementById(`${prefix}ips-tab`);
      if (ipsTab && domains.size === 0) ipsTab.click();
      
      const ipsArray = Array.from(ips);
      const ipInput = document.getElementById(`${prefix}ips_inputIP`);
      
      if (ipInput) {
        ipInput.value = ipsArray[0];
        
        for (let i = 1; i < ipsArray.length; i++) {
          instance.addInputField('ip_only', 'ips');
          
          setTimeout(() => {
            const container = document.getElementById(`${prefix}ipsInputContainer`);
            const lastGroup = container?.lastElementChild;
            if (lastGroup) {
              const input = lastGroup.querySelector('.ip');
              if (input) input.value = ipsArray[i];
            }
          }, i * 50);
        }
      }
    }

    if (prefillParams?.scope_id_domains) {
      setTimeout(() => {
        const scopeTab = document.getElementById(`${prefix}domains-scope-tab`);
        if (scopeTab) scopeTab.click();
        instance.state[`${prefix}domains_selectedScopeId`] = prefillParams.scope_id_domains;
        
        const btn = document.getElementById(`${prefix}domains-ScopeDropdown`);
        if (btn) btn.textContent = `Scope ID: ${prefillParams.scope_id_domains}`;
      }, 200);
    }

    if (prefillParams?.scope_id_ips) {
      setTimeout(() => {
        const scopeTab = document.getElementById(`${prefix}ips-scope-tab`);
        if (scopeTab) scopeTab.click();
        instance.state[`${prefix}ips_selectedScopeId`] = prefillParams.scope_id_ips;
        
        const btn = document.getElementById(`${prefix}ips-ScopeDropdown`);
        if (btn) btn.textContent = `Scope ID: ${prefillParams.scope_id_ips}`;
      }, 200);
    }

    if (prefillParams?.agent_id) {
      instance.state.overrides.agent_id = prefillParams.agent_id;
    }
    
    window[`show_${instance.modalId}`]();
  },

  handleTextareaPrefill(instance, type, lines) {
    const prefix = instance.prefix;
    const textarea = document.getElementById(`${prefix}${type}_textareaInput`);
    
    if (textarea) {
      textarea.value = lines.join('\n');
    }
  },

  handleDatabaseSelection(instance, type, rows) {
    const prefix = instance.prefix;
    
    setTimeout(() => {
      if (instance.databaseTables?.[type]) {
        instance.databaseTables[type].setData().then(() => {
          setTimeout(() => {
            const rowsToSelect = [];
            const tableData = instance.databaseTables[type].getData();
            
            rows.forEach(row => {
              if (type === 'domains') {
                const match = tableData.find(tableRow => 
                  tableRow.domain === (row.domain || row.ipaddr || '')
                );
                if (match) rowsToSelect.push(match);
              } else {
                const match = tableData.find(tableRow => 
                  tableRow.ipaddr === (row.ip || row.ipaddr || '')
                );
                if (match) rowsToSelect.push(match);
              }
            });
            
            if (rowsToSelect.length > 0) {
              instance.databaseTables[type].selectRow(rowsToSelect);
            }
          }, 200);
        });
      }
    }, 300);
  }
};

class WhoisScanner {
  constructor(prefix) {
    this.prefix = prefix;
  }

  getBaseParams() {
    const agentId = window.agentData?.default_agent;
    const overrideAgent = this.instance?.state?.overrides?.agent_id;

    const agent_id = overrideAgent || agentId;

    if (!agent_id) {
      throw new Error("Please select an Agent");
    }

    return {
      agent_id: String(agent_id)
    };
  }

  async whoisDomains(targets) {
    const baseParams = this.getBaseParams();
    const tasks = [];

    for (const target of targets) {
      let domain = '';
      
      if (typeof target === 'string') {
        domain = target;
      } else {
        domain = target.domain || target.target || '';
      }
      
      if (!domain || isIPv4(domain)) continue;
      
      const payload = {
        ...baseParams,
        target: String(domain).trim()
      };

      tasks.push({
        endpoint: '/api/v1/task/rdap_task',
        payload
      });
    }

    if (tasks.length === 0) return [];

    const result = await window.executeToolTasks({
      tasks,
      stopOnFirstFailure: true
    });

    if (!result.success) {
      if (result.reason === 'module_install_requested') {
        return null;
      }
      throw new Error(result.error?.message || 'RDAP scan failed');
    }

    return result.responses;
  }

  async whoisIps(targets) {
    const baseParams = this.getBaseParams();
    const tasks = [];

    for (const target of targets) {
      let ip = '';
      
      if (typeof target === 'string') {
        ip = target;
      } else {
        ip = target.ip || target.target || '';
      }
      
      if (!ip || !isIPv4(ip)) continue;
      
      const payload = {
        ...baseParams,
        target: String(ip).trim()
      };

      tasks.push({
        endpoint: '/api/v1/task/whois_shdws_task',
        payload
      });
    }

    if (tasks.length === 0) return [];

    const result = await window.executeToolTasks({
      tasks,
      stopOnFirstFailure: true
    });

    if (!result.success) {
      if (result.reason === 'module_install_requested') {
        return null;
      }
      throw new Error(result.error?.message || 'WHOIS scan failed');
    }

    return result.responses;
  }

  async whoisDomainsScope(scopeId) {
    const baseParams = this.getBaseParams();
    const payload = {
      ...baseParams,
      scope_id: String(scopeId)
    };

    const result = await window.executeToolTasks({
      tasks: [{
        endpoint: '/api/v1/task/rdap_task',
        payload
      }],
      stopOnFirstFailure: true
    });

    if (!result.success) {
      if (result.reason === 'module_install_requested') {
        return null;
      }
      throw new Error(result.error?.message || 'RDAP scope scan failed');
    }

    return result.responses[0];
  }

  async whoisIpsScope(scopeId) {
    const baseParams = this.getBaseParams();
    const payload = {
      ...baseParams,
      scope_id: String(scopeId)
    };

    const result = await window.executeToolTasks({
      tasks: [{
        endpoint: '/api/v1/task/whois_shdws_task',
        payload
      }],
      stopOnFirstFailure: true
    });

    if (!result.success) {
      if (result.reason === 'module_install_requested') {
        return null;
      }
      throw new Error(result.error?.message || 'WHOIS scope scan failed');
    }

    return result.responses[0];
  }
}

class WhoisModalBuilder extends ToolModalBuilder {
  constructor(modalId, config) {
    super(modalId, config);
  }

  buildModalContent() {
    return `
      ${this.buildToolsHeader()}
      ${WhoisUI.buildCustomTabs(this.prefix)}
      ${this.buildDualTabContent()}
      ${this.buildActionButtons()}
    `;
  }

  buildDualTabContent() {
    return `
      <div class="tab-content" id="${this.prefix}tabContent">
        <!-- Domains Tab Pane -->
        <div class="tab-pane fade show active" 
             id="${this.prefix}domains-mode" 
             role="tabpanel">
          ${this.buildSubTabs('domains')}
        </div>
        
        <!-- IPs Tab Pane -->
        <div class="tab-pane fade" 
             id="${this.prefix}ips-mode" 
             role="tabpanel">
          ${this.buildSubTabs('ips')}
        </div>
      </div>
    `;
  }

  buildSubTabs(type) {
    const targetType = type === 'domains' ? 'domain_only' : 'ip_only';
    const placeholder = type === 'domains' ? 'example.com' : '192.168.1.1';
    
    return `
      <div class="tab-content w-100" id="${this.prefix}${type}-tab-content" style="padding-top: 7px;">
        <div class="nav nav-tabs me-3 mb-3" id="${this.prefix}${type}-tabs" role="tablist">
          <button class="nav-link active" 
                  id="${this.prefix}${type}-simple-tab" 
                  data-bs-toggle="tab" 
                  data-bs-target="#${this.prefix}${type}-simple-mode" 
                  type="button" 
                  role="tab">
            ${i18next.t('Target')}
          </button>
          <button class="nav-link" 
                  id="${this.prefix}${type}-scope-tab" 
                  data-bs-toggle="tab" 
                  data-bs-target="#${this.prefix}${type}-scope-mode" 
                  type="button" 
                  role="tab">
            ${i18next.t('Scope')}
          </button>
          <button class="nav-link" 
                  id="${this.prefix}${type}-database-tab" 
                  data-bs-toggle="tab" 
                  data-bs-target="#${this.prefix}${type}-database-mode" 
                  type="button" 
                  role="tab">
            ${i18next.t('Database')}
          </button>
          <!-- 
          <button class="nav-link" 
                  id="${this.prefix}${type}-textarea-tab" 
                  data-bs-toggle="tab" 
                  data-bs-target="#${this.prefix}${type}-textarea-mode" 
                  type="button" 
                  role="tab">
            ${i18next.t('Textarea')}
          </button>
          -->
        </div>
        
        <div class="tab-content">
          <div class="tab-pane fade show active" 
               id="${this.prefix}${type}-simple-mode" 
               role="tabpanel">
            ${this.buildTargetTab(targetType, type)}
          </div>
          <div class="tab-pane fade" 
               id="${this.prefix}${type}-scope-mode" 
               role="tabpanel">
            ${this.buildScopeTab(type)}
          </div>
          <div class="tab-pane fade" 
               id="${this.prefix}${type}-database-mode" 
               role="tabpanel">
            ${this.buildDatabaseTab(type)}
          </div>
          <!-- 
          <div class="tab-pane fade" 
               id="${this.prefix}${type}-textarea-mode" 
               role="tabpanel">
            ${this.buildTextareaTab(type, placeholder)}
          </div>
          -->
        </div>
      </div>
    `;
  }

  buildTargetTab(targetType, type) {
    const prefix = `${this.prefix}${type}_`;
    const containerId = `${this.prefix}${type}InputContainer`;
    
    if (targetType === 'domain_only') {
      return `
        <div id="${containerId}"></div>
        <div class="input-group" style="padding-top: 7px;" id="${prefix}domainTarget">
          <span class="input-group-text">Domain</span>
          <input type="text" class="form-control domain" id="${prefix}inputDomain" 
                 placeholder="example.com" required>
          <button type="button" class="btn btn-success" style="width: 3rem"
                  onclick="ToolModalBuilder.instances['${this.modalId}'].addInputField('domain_only', '${type}')">+</button>
        </div>
      `;
    } else {
      return `
        <div id="${containerId}"></div>
        <div class="input-group" style="padding-top: 7px;" id="${prefix}ipTarget">
          <span class="input-group-text">IP</span>
          <input type="text" class="form-control ip" id="${prefix}inputIP" 
                 placeholder="IP address" required>
          <button type="button" class="btn btn-success" style="width: 3rem"
                  onclick="ToolModalBuilder.instances['${this.modalId}'].addInputField('ip_only', '${type}')">+</button>
        </div>
      `;
    }
  }

  buildScopeTab(type) {
    return `
      <div class="dropdown w-100 mt-2">
        <button class="btn btn dropdown-toggle w-100" style="--bs-btn-border-color:#d4d9de;"
                type="button" id="${this.prefix}${type}-ScopeDropdown" data-bs-toggle="dropdown">
          Select scope
        </button>
        <ul class="dropdown-menu w-100" id="${this.prefix}${type}-dropdownMenuForScopeData"></ul>
      </div>
    `;
  }

  buildDatabaseTab(type) {
    return `
      <div class="database-tab-content">    
        <div class="targets-selection-area mb-3" 
             style="border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
          <div id="${this.prefix}${type}DatabaseTargetsTable"></div>
        </div>
      </div>
    `;
  }

  buildTextareaTab(type, placeholder) {
    return `
      <div class="mt-2 position-relative" id="${this.prefix}${type}-textareaContainer">
        <textarea class="form-control" id="${this.prefix}${type}_textareaInput" 
                  rows="10" placeholder="${placeholder}" 
                  style="transition: all 0.2s ease;"></textarea>
        
        <div id="${this.prefix}${type}-textareaOverlay" 
             class="d-none d-flex align-items-center justify-content-center"
             style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(13, 110, 253, 0.05); border: 2px dashed #0d6efd; 
                    border-radius: 0.375rem; pointer-events: none; z-index: 10;">
          <div class="bg-white px-3 py-2 rounded shadow-sm border border-primary text-primary">
            <i class="bi bi-file-earmark-arrow-down fs-4 me-2"></i>
            <strong>Drop file to import</strong>
          </div>
        </div>

        <small class="form-text text-muted">
          Enter targets manually or <b>drag and drop a .txt file</b> here.
        </small>
      </div>
    `;
  }

  initComponents() {
    if (!this.databaseTables) {
      this.databaseTables = {};
    }
    
    super.initComponents();
    this.initDualScopeDropdowns();
    this.initDualDatabaseTables();
    //this.initDualTextareaDragDrop();
  }

  initDualScopeDropdowns() {
    ['domains', 'ips'].forEach(type => {
      this.initScopeDropdown(type);
    });
  }

  initScopeDropdown(type) {
    const dropdown = document.getElementById(`${this.prefix}${type}-dropdownMenuForScopeData`);
    if (!dropdown) return;
    
    axios.get("/api/v1/scope")
      .then((resp) => {
        dropdown.innerHTML = "";
        resp.data.forEach((item) => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.classList.add("dropdown-item");
          a.href = "#";
          a.textContent = item.name;
          a.addEventListener("click", (e) => {
            e.preventDefault();
            document.getElementById(`${this.prefix}${type}-ScopeDropdown`).textContent = item.name;
            this.state[`${this.prefix}${type}_selectedScopeId`] = item.id;
          });
          li.appendChild(a);
          dropdown.appendChild(li);
        });
      })
      .catch((err) => {});
  }

  initDualDatabaseTables() {
    ['domains', 'ips'].forEach(type => {
      this.initDatabaseTable(type);
    });
  }

  initDatabaseTable(type) {
    const container = document.getElementById(`${this.prefix}${type}DatabaseTargetsTable`);
    if (!container) {
      return;
    }
    
    try {
      let columns, ajaxParams;
      
      if (type === 'domains') {
        columns = [
          { 
            title: "Select", 
            field: "selected", 
            formatter: "rowSelection", 
            titleFormatter: "rowSelection", 
            hozAlign: "center", 
            headerHozAlign: "center", 
            headerSort: false,
            formatterParams: { selectAll: false }
          },
          { 
            title: "Domain", 
            field: "domain", 
            headerFilter: "input", 
            headerFilterPlaceholder: "Search domain..." 
          },
          { 
            title: "IP Address", 
            field: "ipaddr", 
            headerFilter: "input", 
            headerFilterPlaceholder: "Search IP..." 
          }
        ];
        
        ajaxParams = {
          scans: window.selectedScans || [],
          filters: JSON.stringify([
            {
              field: "domain",
              type: "!=",
              value: ""
            }
          ])
        };
      } else {
        columns = [
          { 
            title: "Select", 
            field: "selected", 
            formatter: "rowSelection", 
            titleFormatter: "rowSelection", 
            hozAlign: "center", 
            headerHozAlign: "center", 
            headerSort: false,
            formatterParams: { selectAll: false }
          },
          { 
            title: "IP Address", 
            field: "ipaddr", 
            headerFilter: "input", 
            headerFilterPlaceholder: "Search IP..." 
          },
          { 
            title: "Domain", 
            field: "domain", 
            headerFilter: "input", 
            headerFilterPlaceholder: "Search domain..." 
          }
        ];
        
        ajaxParams = {
          scans: window.selectedScans || [],
          filters: JSON.stringify([
            {
              field: "ipaddr",
              type: "!=",
              value: ""
            }
          ])
        };
      }

      const table = new Tabulator(container, {
        layout: "fitColumns",
        ajaxURL: "/api/v1/target/get_all_data",
        ajaxParams: ajaxParams,
        ajaxURLGenerator: (url, config, params) => {
          const sort = encodeURIComponent(JSON.stringify(params.sort || []));
          const filter = encodeURIComponent(JSON.stringify(params.filter || []));
          const page = params.page || 1;
          const size = params.size || 10;
          
          let filters = [];
          if (params.filter) {
            filters = params.filter;
          }
          
          if (type === 'domains') {
            filters.push({
              field: "domain",
              type: "!=",
              value: ""
            });
          } else {
            filters.push({
              field: "ipaddr",
              type: "!=",
              value: ""
            });
          }
          
          const filterEncoded = encodeURIComponent(JSON.stringify(filters));
          const scansParam = (window.selectedScans || [])
            .map((scan) => `scans=${encodeURIComponent(scan)}`)
            .join("&");
            
          return `${url}?page=${page}&size=${size}&sort=${sort}&filter=${filterEncoded}${scansParam ? `&${scansParam}` : ""}`;
        },
        selectable: true,
        sortMode: "remote",
        filterMode: "remote",
        pagination: true,
        paginationMode: "remote",
        paginationSize: 10,
        paginationSizeSelector: [10, 25, 50, 100],
        columns: columns,
        rowSelectionChanged: (data, rows) => {
          const targetsMap = new Map();
          
          rows.forEach((row) => {
            const rowData = row.getData();
            
            if (type === 'domains' && rowData.domain) {
              targetsMap.set(rowData.domain, {
                domain: rowData.domain,
                ip: rowData.ipaddr
              });
            } else if (type === 'ips' && rowData.ipaddr) {
              targetsMap.set(rowData.ipaddr, {
                ip: rowData.ipaddr,
                domain: rowData.domain
              });
            }
          });
          
          this.state[`${this.prefix}${type}_selectedDatabaseTargets`] = {};
          targetsMap.forEach((value, key) => {
            this.state[`${this.prefix}${type}_selectedDatabaseTargets`][key] = value;
          });
        }
      });
      
      this.databaseTables[type] = table;
    } catch (error) {}
  }

  syncDatabaseTargetsFromTable(type) {
    if (!this.databaseTables || !this.databaseTables[type]) {
      return;
    }
    
    const selectedRows = this.databaseTables[type].getSelectedRows();
    const targetsMap = new Map();
    
    selectedRows.forEach((row) => {
      const rowData = row.getData();
      
      if (type === 'domains' && rowData.domain) {
        targetsMap.set(rowData.domain, {
          domain: rowData.domain,
          ip: rowData.ipaddr
        });
      } else if (type === 'ips' && rowData.ipaddr) {
        targetsMap.set(rowData.ipaddr, {
          ip: rowData.ipaddr,
          domain: rowData.domain
        });
      }
    });
    
    this.state[`${this.prefix}${type}_selectedDatabaseTargets`] = {};
    targetsMap.forEach((value, key) => {
      this.state[`${this.prefix}${type}_selectedDatabaseTargets`][key] = value;
    });
  }

  initDualTextareaDragDrop() {
    ['domains', 'ips'].forEach(type => {
      this.initTextareaDragDrop(type);
    });
  }

  initTextareaDragDrop(type) {
    const container = document.getElementById(`${this.prefix}${type}-textareaContainer`);
    const textarea = document.getElementById(`${this.prefix}${type}_textareaInput`);
    const overlay = document.getElementById(`${this.prefix}${type}-textareaOverlay`);

    if (!container || !textarea || !overlay) return;

    ['dragenter', 'dragover'].forEach(eventName => {
      container.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        overlay.classList.remove('d-none');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      container.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
        overlay.classList.add('d-none');
      }, false);
    });

    container.addEventListener('drop', (e) => {
      const file = e.dataTransfer.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          textarea.value = event.target.result;
          textarea.dispatchEvent(new Event('input'));
        };
        reader.readAsText(file);
      }
    }, false);
  }

  addInputField(type, subType = null) {
    const typePrefix = subType ? `${subType}_` : '';
    const container = document.getElementById(`${this.prefix}${subType}InputContainer`);
    
    const typeToId = {
      'ip_only': 'ipTarget',
      'domain_only': 'domainTarget'
    };
    
    const originalId = `${this.prefix}${typePrefix}${typeToId[type]}`;
    const original = document.getElementById(originalId);
    
    if (!container || !original) return;

    const clone = original.cloneNode(true);
    const timestamp = Date.now();
    clone.removeAttribute("id");
    
    const originalInputs = original.querySelectorAll("input");
    const cloneInputs = clone.querySelectorAll("input");

    cloneInputs.forEach((cloneInp, index) => {
      const orgInp = originalInputs[index];
      if (orgInp.id) {
        cloneInp.id = `${orgInp.id}_${timestamp}`;
      }
      cloneInp.value = orgInp.value;
      orgInp.value = "";
    });

    const addButton = clone.querySelector(".btn-success");
    if (addButton) {
      addButton.remove();
    }
    
    const removeBtn = document.createElement("button");
    removeBtn.textContent = "-";
    removeBtn.type = "button";
    removeBtn.className = "btn btn-danger";
    removeBtn.style.width = "3rem";
    removeBtn.onclick = () => clone.remove();

    clone.appendChild(removeBtn);
    container.appendChild(clone);
  }

  getActiveType() {
    const activeTab = document.querySelector(`#${this.prefix}typeTabs .nav-link.active`);
    if (!activeTab) return 'domains';
    return activeTab.id.replace(this.prefix, '').replace('-tab', '');
  }

  getTargetsFromTextarea(type) {
    const textarea = document.getElementById(`${this.prefix}${type}_textareaInput`);
    if (!textarea || !textarea.value) return [];
    
    const lines = textarea.value.split("\n");
    const targets = [];
    
    lines.forEach(line => {
      const trimmed = line.trim();
      if (!trimmed) return;
      
      if (type === 'domains' && WhoisHandlers.isValidDomain(trimmed)) {
        targets.push({ domain: trimmed, target: trimmed });
      } else if (type === 'ips' && isIPv4(trimmed)) {
        targets.push({ ip: trimmed, target: trimmed });
      }
    });
    
    return targets;
  }

  getTargetsFromDatabase(type) {
    this.syncDatabaseTargetsFromTable(type);
    
    const selectedTargets = this.state[`${this.prefix}${type}_selectedDatabaseTargets`] || {};
    const targets = [];
    
    Object.values(selectedTargets).forEach(item => {
      if (type === 'domains' && item.domain) {
        targets.push({ domain: item.domain, target: item.domain });
      } else if (type === 'ips' && item.ip) {
        targets.push({ ip: item.ip, target: item.ip });
      }
    });
    
    return targets;
  }

  getTargets() {
    const type = this.getActiveType();
    const activeSubTab = document.querySelector(`#${this.prefix}${type}-tabs .nav-link.active`);
    
    if (!activeSubTab) return { targets: [], type };
    
    const tabId = activeSubTab.id;
    
    if (tabId.includes('-scope-tab')) {
      const scopeId = this.state[`${this.prefix}${type}_selectedScopeId`];
      return { scope_id: scopeId, type };
    } else if (tabId.includes('-database-tab')) {
      const targets = this.getTargetsFromDatabase(type);
      return { targets, type };
    } else if (tabId.includes('-textarea-tab')) {
      const targets = this.getTargetsFromTextarea(type);
      return { targets, type };
    } else {
      const targets = [];
      const typePrefix = `${type}_`;
      
      const getValue = (selector) => {
        const el = document.querySelector(selector);
        return el ? el.value.trim() : "";
      };

      if (type === 'domains') {
        const domain = getValue(`#${this.prefix}${typePrefix}inputDomain`);
        if (domain) targets.push({ domain, target: domain });
      } else {
        const ip = getValue(`#${this.prefix}${typePrefix}inputIP`);
        if (ip) targets.push({ ip, target: ip });
      }

      const containerInputs = document.querySelectorAll(`#${this.prefix}${type}InputContainer .input-group`);
      containerInputs.forEach((group) => {
        if (type === 'domains') {
          const domainEl = group.querySelector(".domain");
          if (domainEl && domainEl.value.trim()) {
            targets.push({ domain: domainEl.value.trim(), target: domainEl.value.trim() });
          }
        } else {
          const ipEl = group.querySelector(".ip");
          if (ipEl && ipEl.value.trim()) {
            targets.push({ ip: ipEl.value.trim(), target: ipEl.value.trim() });
          }
        }
      });
      
      return { targets, type };
    }
  }

  reset() {
    super.reset();
    
    ['domains', 'ips'].forEach(type => {
      this.state[`${this.prefix}${type}_selectedScopeId`] = null;
      this.state[`${this.prefix}${type}_selectedDatabaseTargets`] = {};
      
      const container = document.getElementById(`${this.prefix}${type}InputContainer`);
      if (container) container.innerHTML = '';
      
      const textarea = document.getElementById(`${this.prefix}${type}_textareaInput`);
      if (textarea) textarea.value = '';
      
      if (this.databaseTables && this.databaseTables[type]) {
        this.databaseTables[type].deselectRow();
      }
    });

    const domainsTab = document.getElementById(`${this.prefix}domains-tab`);
    if (domainsTab) domainsTab.click();
  }

  async start() {
    const scanner = new WhoisScanner(this.prefix);
    scanner.instance = this;
    
    try {
      const result = this.getTargets();
      const type = result.type;
      const targets = result.targets || [];
      const scopeId = result.scope_id;
      let scanResult;

      if (scopeId) {
        if (type === 'domains') {
          scanResult = await scanner.whoisDomainsScope(scopeId);
        } else {
          scanResult = await scanner.whoisIpsScope(scopeId);
        }
      } else {
        if (!targets.length) {
          create_toast('Warning', i18next.t(`Please enter at least one ${type === 'domains' ? 'domain' : 'IP address'}`), 'warning');
          return;
        }
        
        if (type === 'domains') {
          const valid = targets.map(t => t.target).filter(WhoisHandlers.isValidDomain);
          if (!valid.length) {
            create_toast('Error', i18next.t('No valid domains found'), 'error');
            return;
          }
          scanResult = await scanner.whoisDomains(valid);
        } else {
          const valid = targets.map(t => t.target).filter(isIPv4);
          if (!valid.length) {
            create_toast('Error', i18next.t('No valid IPv4 addresses found'), 'error');
            return;
          }
          scanResult = await scanner.whoisIps(valid);
        }
      }

      if (scanResult !== null) {
        window[`close_${this.modalId}`]();
      }
    } catch (error) {
      create_toast('Error', error.message || i18next.t('Failed to start scan'), 'error');
    }
  }
}

// Register the custom builder
(function() {
  const modalId = 'whoisModalWindow';
  const config = {
    prefix: 'whois_',
    
    onInit(instance) {
      WhoisScanner.prototype.instance = instance;
      
      window.whois_script_modal_to_node = (value) => {
        WhoisHandlers.handleNodeModal(instance, value);
      };

      window.whois_start_with_prefill = (rows, prefillParams) => {
        WhoisHandlers.handlePrefill(instance, rows, prefillParams);
      };

      window.whois_script_modal_to_info_tabs = async (rows) => {
        WhoisHandlers.handlePrefill(instance, rows);
      };

      window.whois_script_modal_to_database = async (rows, type) => {
        WhoisHandlers.handleDatabaseSelection(instance, type || 'domains', rows);
      };

      window.whois_prefill_textarea = (type, lines) => {
        WhoisHandlers.handleTextareaPrefill(instance, type, lines);
      };
    },

    onReset(instance) {
      const prefix = instance.prefix;
      
      ['domains', 'ips'].forEach(type => {
        const container = document.getElementById(`${prefix}${type}InputContainer`);
        if (container) container.innerHTML = '';
        
        if (type === 'domains') {
          const input = document.getElementById(`${prefix}${type}_inputDomain`);
          if (input) input.value = '';
        } else {
          const input = document.getElementById(`${prefix}${type}_inputIP`);
          if (input) input.value = '';
        }
      });
      
      instance.state.overrides = {};
    }
  };

  const init = () => { 
    ToolModalBuilder.instances[modalId] = new WhoisModalBuilder(modalId, config); 
  };
  
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>