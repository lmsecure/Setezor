{% from "modals/base_modal_framework.html" import tools_header_bar, target_scope_database_tabs, base_input, base_scope, base_database_content, base_modal %}

{# Специфичная логика для brute инструмента - основная часть #}
{% macro brute_main_content() %}
{# Поле для загрузки файла #}
<div class="mt-3 mb-3">
    <label for="bruteFileUpload" class="form-label" data-i18n="Upload wordlist file (optional):"></label>
    <input class="form-control" type="file" id="bruteFileUpload" accept=".txt">
</div>

<div class="btn-group d-flex my-2" role="group">
    <input class="btn btn-outline-secondary w-50" name="reset_params" type="reset" data-i18n="Reset Params">
    <button type="button" class="btn btn-primary w-50" id="startBruteFind" 
            onclick="processBruteTask()" data-i18n="Start"></button>
</div>
{% endmacro %}

{# Форма brute инструмента #}
{% macro brute_form() %}
<form id="BruteForm" name="BruteFormName" class="needs-validation" novalidate>
    {{ target_scope_database_tabs(
        prefix='brute-',
        simple_content=base_input(prefix='brute', placeholder_i18n='Domain name or IP'),
        scope_content=base_scope(prefix='brute-'),
        database_content=base_database_content(
            prefix='brute-',
            table_id='bruteDatabaseTargetsTable',
            selected_targets_var='selectedBruteTargets'
        )
    ) }}
    {{ brute_main_content() }}
</form>
{% endmacro %}

{# Глобальные функции для brute tool #}
{% macro brute_global_functions() %}
// Глобальная переменная для хранения загруженного файла
window.bruteUploadedFile = null;

window.show_bruteModalWindow = function() {
    console.log('show_bruteModalWindow called');
    resetBruteModal();
    const myModal = new bootstrap.Modal(document.getElementById('bruteModalWindow'));
    myModal.show();
    
    // Инициализируем таблицу при открытии модалки
    setTimeout(() => {
        initBruteDatabase();
        // Загружаем список scope
        get_scope_list('brute-');
    }, 100);
}

window.close_bruteModalWindow = function() {
    const myModal = bootstrap.Modal.getInstance(document.getElementById('bruteModalWindow'));
    if (myModal) {
        myModal.hide();
    }
}

// Функция сброса для brute модального окна
window.resetBruteModal = function() {
    const bruteForm = document.getElementById('BruteForm');
    if (bruteForm) bruteForm.reset();

    const container = document.getElementById('bruteInputContainer');
    if (container) container.innerHTML = '';

    const originalInput = document.getElementById('bruteinput');
    if (originalInput) originalInput.value = '';

    const dropdownButton = document.getElementById('brute-ScopeDropdown');
    if (dropdownButton) dropdownButton.textContent = 'Select scope';
    
    // Сбрасываем загруженный файл
    const fileInput = document.getElementById('bruteFileUpload');
    if (fileInput) fileInput.value = '';
    window.bruteUploadedFile = null;
    
    window.selectedScope_brute = '';
    window.selectedBruteTargets = {};

    // Сброс вкладок
    const simpleTab = document.getElementById('brute-simple-tab');
    const scopeTab = document.getElementById('brute-scope-tab');
    const databaseTab = document.getElementById('brute-database-tab');
    const simpleMode = document.getElementById('brute-simple-mode');
    const scopeMode = document.getElementById('brute-scope-mode');
    const databaseMode = document.getElementById('brute-database-mode');
    
    if (simpleTab && scopeTab && databaseTab && simpleMode && scopeMode && databaseMode) {
        simpleTab.classList.add('active');
        scopeTab.classList.remove('active');
        databaseTab.classList.remove('active');
        simpleMode.classList.add('show', 'active');
        scopeMode.classList.remove('show', 'active');
        databaseMode.classList.remove('show', 'active');
    }
    
    // Очищаем выбор в таблице
    if (window.bruteDatabaseTargetsTable && typeof window.bruteDatabaseTargetsTable.deselectRow === 'function') {
        window.bruteDatabaseTargetsTable.deselectRow();
    }
}

// Инициализация таблицы при открытии модалки
window.initBruteDatabase = function() {
    window.bruteDatabaseTargetsTable = initDatabaseTable(
        'bruteDatabaseTargetsTable', 
        'selectedBruteTargets', 
        'brute-SelectedCount'
    );
    
    // Добавляем обработчик для rowSelectionChanged
    if (window.bruteDatabaseTargetsTable) {
        window.bruteDatabaseTargetsTable.on("rowSelectionChanged", function(data, rows) {
            console.log('Row selection changed:', rows.length, 'rows selected');
            window.selectedBruteTargets = {};
            
            rows.forEach(row => {
                const rowData = row.getData();
                const uniqueKey = `${rowData.ipaddr}:${rowData.domain}`;
                window.selectedBruteTargets[uniqueKey] = {
                    ip: rowData.ipaddr,
                    domain: rowData.domain,
                    port: rowData.port
                };
            });
            
            console.log('Updated selectedBruteTargets:', window.selectedBruteTargets);
        });
    }
    
    // Добавляем обработчик для загрузки файла
    const fileInput = document.getElementById('bruteFileUpload');
    if (fileInput) {
        fileInput.addEventListener('change', handleBruteFileUpload);
    }
}

// Обработчик загрузки файла
window.handleBruteFileUpload = function(event) {
    const file = event.target.files[0];
    if (file) {
        // Проверяем размер файла (максимум 10MB)
        if (file.size > 10 * 1024 * 1024) {
            create_toast('Error', 'File size too large. Maximum 10MB allowed.', 'error');
            event.target.value = '';
            return;
        }
        
        window.bruteUploadedFile = file;
    } else {
        window.bruteUploadedFile = null;
    }
}

window.readFileAsBase64 = function(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64 = event.target.result;
            resolve(base64);
        };
        reader.onerror = function(error) {
            reject(error);
        };
        reader.readAsDataURL(file);
    });
}

window.sendBruteTaskWithFile = async function(params, file) {
    
    const requestParams = {
        ...params,
        crt_sh: false
    };
    
    if (file) {
        try {
            const base64File = await readFileAsBase64(file);
            requestParams.dict_file = base64File;
            console.log('File converted to base64, size:', base64File.length);
        } catch (error) {
            console.error('Error reading file:', error);
            create_toast('Error','Error reading file. Please try again.', 'error');
            return;
        }
    }
    
    fetch('/api/v1/task/sd_find', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestParams)
    })
    .then(response => {
        console.log('BRUTE task response:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .catch(error => {
        console.error('BRUTE task error:', error);
        create_toast('Error', 'Error starting BRUTE task: ' + error.message, 'error');
    });
}

// Бизнес-логика brute инструмента
window.sendBruteTask = function(params) {
    console.log('Sending BRUTE task:', params);
    
    // Используем новую функцию с поддержкой файлов
    sendBruteTaskWithFile(params, window.bruteUploadedFile);
}

window.handleBruteSimpleMode = function(params) {
    const targets = [];
    const targetInputs = document.querySelectorAll('#BruteForm [id^="bruteinput"]');
    
    for (const input of targetInputs) {
        if (input.value.trim() !== '') {
            targets.push(input.value.trim());
        }
    }

    console.log('Processing simple mode targets:', targets);

    for (const target of targets) {
        const targetParams = {
            ...params,
            domain: target,
            agent_id: getAgent()
        };

        sendBruteTask(targetParams);
    }
}

window.handleBruteScopeMode = function(params) {
    // ИСПРАВЛЕНО: используем правильное имя переменной
    if (!window['selectedScope_brute-'] || window['selectedScope_brute-'] === '') {
        create_toast('Warning', 'Please select a scope first', 'warning');
        return;
    }
    
    params['scope_id'] = window['selectedScope_brute-'];
    params['agent_id'] = getAgent();

    console.log('Processing scope mode with scope ID:', window['selectedScope_brute-']);

    sendBruteTask(params);
}

window.handleBruteDatabaseMode = function(params) {
    // Проверяем, что есть выбранные цели
    if (!window.selectedBruteTargets || Object.keys(window.selectedBruteTargets).length === 0) {
        create_toast('Warning', 'Please select targets from database first', 'warning');
        return;
    }
    
    const targets = Object.values(window.selectedBruteTargets);
    
    console.log('Processing database targets:', targets);
    
    // Собираем уникальные цели (домены или IP) из выбранных целей
    const uniqueTargets = new Set();
    
    for (const target of targets) {
        // Используем domain если есть, иначе ip
        const targetValue = target.domain || target.ip;
        if (targetValue && targetValue.trim() !== '') {
            uniqueTargets.add(targetValue.trim());
        }
    }
    
    const targetsArray = Array.from(uniqueTargets);
    console.log('Unique targets from database selection:', targetsArray);
    
    if (targetsArray.length === 0) {
        create_toast('Warning', 'No valid targets found in selected targets', 'warning');
        return;
    }
    
    // Отправляем задачи для каждого уникального домена/IP
    for (const target of targetsArray) {
        const targetParams = {
            ...params,
            target: target,
            agent_id: getAgent()
        };

        console.log('Sending BRUTE task for target:', target, 'with params:', targetParams);
        
        sendBruteTask(targetParams);
    }
}

window.processBruteTask = function() {
    const params = {};
    const agent_id = getAgent();
    
    if (!agent_id) {
        create_toast('Warning', 'Please select an agent first', 'warning');
        return;
    }

    params['agent_id'] = agent_id;

    const simpleForm = document.getElementById('brute-simple-mode');
    const scopeForm = document.getElementById('brute-scope-mode');
    const databaseForm = document.getElementById('brute-database-mode');

    console.log('Processing brute task with mode:', {
        simple: simpleForm?.classList.contains('show') && simpleForm.classList.contains('active'),
        scope: scopeForm?.classList.contains('show') && scopeForm.classList.contains('active'),
        database: databaseForm?.classList.contains('show') && databaseForm.classList.contains('active'),
        selectedBruteTargets: window.selectedBruteTargets,
        selectedScope: window['selectedScope_brute-']
    });

    if (simpleForm && simpleForm.classList.contains('show') && simpleForm.classList.contains('active')) {
        handleBruteSimpleMode(params);
    } else if (scopeForm && scopeForm.classList.contains('show') && scopeForm.classList.contains('active')) {
        handleBruteScopeMode(params);
    } else if (databaseForm && databaseForm.classList.contains('show') && databaseForm.classList.contains('active')) {
        handleBruteDatabaseMode(params);
    } else {
        console.error('No active tab found');
        create_toast('Warning','Please select a target mode (Target/Scope/Database)', 'warning');
        return;
    }

    close_bruteModalWindow();
}

// Вспомогательные функции для интеграции с другими частями системы
window.brute_script_modal_to_node = function(ip) {
    show_bruteModalWindow();
    const inputTarget = document.getElementById('bruteinput');
    if (inputTarget && ip) {
        inputTarget.value = ip;
    }
}

window.brute_script_modal_to_info_tabs = async function(rows) {
    show_bruteModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    // Получаем уникальные непустые цели (домены или IP)
    const uniqueTargets = [...new Set(rows
        .map(row => {
            // Предпочитаем домен, если есть, иначе IP
            return row.domain ? row.domain.trim() : (row.ipaddr ? row.ipaddr.trim() : '');
        })
        .filter(target => target !== '')
    )];
    
    console.log('Unique targets to process:', uniqueTargets);
    
    // Сбрасываем форму
    const container = document.getElementById('bruteInputContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    const originalInput = document.getElementById('bruteinput');
    if (originalInput) {
        originalInput.value = '';
    }
    
    // Заполняем поля ввода
    for (let i = 0; i < uniqueTargets.length; i++) {
        if (i === 0) {
            // Первая цель в основное поле
            const firstInput = document.getElementById('bruteinput');
            if (firstInput) {
                firstInput.value = uniqueTargets[i];
            }
        } else {
            // Остальные цели в дополнительные поля
            addNewInputForm('brute');
            
            // Ждем обновления DOM
            await new Promise(resolve => setTimeout(resolve, 50));
            
            // Находим все input'ы и заполняем последний
            const allInputs = document.querySelectorAll('[id^="bruteinput"]');
            const lastInput = allInputs[allInputs.length - 1];
            if (lastInput) {
                lastInput.value = uniqueTargets[i];
            }
        }
    }
}

// Функция для запуска brute задачи из database вкладки
window.brute_script_modal_to_database = async function(rows) {
    show_bruteModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    // Переключаемся на database вкладку
    const databaseTab = document.getElementById('brute-database-tab');
    if (databaseTab) {
        databaseTab.click();
        
        // Ждем переключения вкладки и инициализации таблицы
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Очищаем текущий выбор в таблице
    if (window.bruteDatabaseTargetsTable) {
        window.bruteDatabaseTargetsTable.deselectRow();
    }
    
    // Выбираем строки в таблице, соответствующие переданным rows
    if (window.bruteDatabaseTargetsTable && rows && rows.length > 0) {
        // Получаем текущие данные таблицы
        const tableData = window.bruteDatabaseTargetsTable.getData();
        console.log('Table data:', tableData);
        console.log('Rows to select:', rows);
        
        // Создаем массив для выбора строк
        const rowsToSelect = [];
        
        // Ищем соответствующие строки в таблице
        for (const row of rows) {
            const matchingRow = tableData.find(tableRow => {
                // Сравниваем по IP и домену
                const ipMatch = tableRow.ipaddr === row.ip;
                const domainMatch = tableRow.domain === row.domain;
                return ipMatch && domainMatch;
            });
            
            if (matchingRow) {
                rowsToSelect.push(matchingRow);
            }
        }
        
        // Выбираем найденные строки
        if (rowsToSelect.length > 0) {
            window.bruteDatabaseTargetsTable.selectRow(rowsToSelect);
            console.log('Selected rows in brute database table:', rowsToSelect.length);
        } else {
            console.warn('No matching rows found in table');
        }
    }
}

// Отладочная информация
console.log('Brute tool global functions loaded');
{% endmacro %}

{# Главный макрос brute инструмента #}
{% macro brute_tool_modal() %}
    {% set modal_content = brute_form() %}
    {% set global_functions = brute_global_functions() %}
    
    {{ base_modal(
        modal_id='bruteModalWindow',
        modal_title='Brute Tool',
        help_url='https://help.setezor.net/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B.html#brute',
        header_bar=tools_header_bar(prefix='brute_'),
        content=modal_content,
        reset_function='resetBruteModal',
        custom_scripts=global_functions
    ) }}
{% endmacro %}