{% from "modals/base_modal_framework.html" import tools_header_bar, target_scope_database_tabs, base_input, base_scope, base_database_content, base_modal %}

{# Специфичная логика для resolve инструмента - основная часть #}
{% macro resolve_main_content() %}
{# Поле для ввода NS серверов #}
<div class="mt-3">
    <label for="resolveNsServer" class="form-label" data-i18n="NS Servers"></label>
    <input type="text" class="form-control" id="resolveNsServer" name="ns_server" 
           placeholder="8.8.8.8, 1.1.1.1" data-bs-toggle="tooltip"
           data-bs-placement="top" data-i18n-title="Optional: Specify nameservers (comma separated)">
    <div class="form-text" data-i18n="Optional: Specify custom nameservers for DNS queries (comma separated)">
    </div>
</div>

<hr class="my-3 bg-secondary">
<div class="btn-group d-flex my-2" role="group">
    <input class="btn btn-outline-secondary w-50" name="reset_params" type="reset" data-i18n="Reset Params">
    <button type="button" class="btn btn-primary w-50" id="startResolveFind" 
            onclick="processResolveTask()" data-i18n="Start"></button>
</div>
{% endmacro %}

{# Форма resolve инструмента #}
{% macro resolve_form() %}
<form id="ResolveForm" name="ResolveFormName" class="needs-validation" novalidate>
    {{ target_scope_database_tabs(
        prefix='resolve-',
        simple_content=base_input(prefix='resolve', placeholder_i18n='Domain name'),
        scope_content=base_scope(prefix='resolve-'),
        database_content=base_database_content(
            prefix='resolve-',
            table_id='resolveDatabaseTargetsTable',
            selected_targets_var='selectedResolveTargets'
        )
    ) }}
    {{ resolve_main_content() }}
</form>
{% endmacro %}

{# Глобальные функции для resolve tool #}
{% macro resolve_global_functions() %}
window.show_resolveModalWindow = function() {
    console.log('show_resolveModalWindow called');
    resetResolveModal();
    const myModal = new bootstrap.Modal(document.getElementById('resolveModalWindow'));
    myModal.show();
    
    // Инициализируем таблицу при открытии модалки
    setTimeout(() => {
        initResolveDatabase();
    }, 100);
}

window.close_resolveModalWindow = function() {
    const myModal = bootstrap.Modal.getInstance(document.getElementById('resolveModalWindow'));
    if (myModal) {
        myModal.hide();
    }
}

// Функция сброса для resolve модального окна
window.resetResolveModal = function() {
    const resolveForm = document.getElementById('ResolveForm');
    if (resolveForm) resolveForm.reset();

    const container = document.getElementById('resolveInputContainer');
    if (container) container.innerHTML = '';

    const originalInput = document.getElementById('resolveinput');
    if (originalInput) originalInput.value = '';

    const nsServerInput = document.getElementById('resolveNsServer');
    if (nsServerInput) nsServerInput.value = '';

    const dropdownButton = document.getElementById('resolve-ScopeDropdown');
    if (dropdownButton) dropdownButton.textContent = 'Select scope';
    
    window.selectedScope_resolve = '';
    window.selectedResolveTargets = {};

    // Сброс вкладок
    const simpleTab = document.getElementById('resolve-simple-tab');
    const scopeTab = document.getElementById('resolve-scope-tab');
    const databaseTab = document.getElementById('resolve-database-tab');
    const simpleMode = document.getElementById('resolve-simple-mode');
    const scopeMode = document.getElementById('resolve-scope-mode');
    const databaseMode = document.getElementById('resolve-database-mode');
    
    if (simpleTab && scopeTab && databaseTab && simpleMode && scopeMode && databaseMode) {
        simpleTab.classList.add('active');
        scopeTab.classList.remove('active');
        databaseTab.classList.remove('active');
        simpleMode.classList.add('show', 'active');
        scopeMode.classList.remove('show', 'active');
        databaseMode.classList.remove('show', 'active');
    }
    
    // Очищаем выбор в таблице
    if (window.resolveDatabaseTargetsTable && typeof window.resolveDatabaseTargetsTable.deselectRow === 'function') {
        window.resolveDatabaseTargetsTable.deselectRow();
    }
}

// Инициализация таблицы при открытии модалки
window.initResolveDatabase = function() {
    window.resolveDatabaseTargetsTable = initDatabaseTable(
        'resolveDatabaseTargetsTable', 
        'selectedResolveTargets', 
        'resolve-SelectedCount'
    );
}

// Бизнес-логика resolve инструмента
window.sendDnsTask = function(params) {
    console.log('Sending DNS task:', params);
    fetch('/api/v1/task/dns_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(params)
    }).then(response => {
        console.log('DNS task response:', response.status);
    }).catch(error => {
        console.error('DNS task error:', error);
    });
}

window.handleResolveSimpleMode = function(params) {
    const domains = [];
    const domainInputs = document.querySelectorAll('#ResolveForm [id^="resolveinput"]');
    
    for (const input of domainInputs) {
        if (input.value.trim() !== '') {
            domains.push(input.value);
        }
    }

    console.log('Processing simple mode domains:', domains);

    for (const domain of domains) {
        const domainParams = {
            ...params,
            domain: domain,
            agent_id: getAgent()
        };

        sendDnsTask(domainParams);
    }
}

window.handleResolveScopeMode = function(params) {
    params['scope_id'] = window.selectedScope_resolve;
    params['agent_id'] = getAgent();

    console.log('Processing scope mode with scope ID:', window.selectedScope_resolve);

    sendDnsTask(params);
}

window.handleResolveDatabaseMode = function(params) {
    const targets = Object.values(window.selectedResolveTargets || {});
    
    console.log('Processing database targets:', targets);
    
    // Собираем уникальные домены из выбранных целей
    const uniqueDomains = new Set();
    
    for (const target of targets) {
        // Используем domain если есть, иначе ip
        const domainValue = target.domain || target.ip;
        if (domainValue && domainValue.trim() !== '') {
            uniqueDomains.add(domainValue.trim());
        }
    }
    
    const domainsArray = Array.from(uniqueDomains);
    console.log('Unique domains from database selection:', domainsArray);
    
    if (domainsArray.length === 0) {
        return;
    }
    
    // Отправляем задачи для каждого уникального домена
    for (const domain of domainsArray) {
        const domainParams = {
            ...params,
            domain: domain,
            agent_id: getAgent()
        };

        console.log('Sending task for domain:', domain, 'with params:', domainParams);
        
        sendDnsTask(domainParams);
    }
}

window.processResolveTask = function() {
    const params = {};
    const nsServerInput = document.getElementById('resolveNsServer');
    
    // Добавляем NS серверы если указаны
    if (nsServerInput && nsServerInput.value.trim() !== '') {
        params['ns_server'] = nsServerInput.value.trim().split(',').map(item => item.trim());
        console.log('Using custom NS servers:', params['ns_server']);
    }
    params['records'] = ['A']
    const simpleForm = document.getElementById('resolve-simple-mode');
    const scopeForm = document.getElementById('resolve-scope-mode');
    const databaseForm = document.getElementById('resolve-database-mode');

    console.log('Processing resolve task with mode:', {
        simple: simpleForm?.classList.contains('show') && simpleForm.classList.contains('active'),
        scope: scopeForm?.classList.contains('show') && scopeForm.classList.contains('active'),
        database: databaseForm?.classList.contains('show') && databaseForm.classList.contains('active'),
        selectedResolveTargets: window.selectedResolveTargets,
        selectedScope: window.selectedScope_resolve,
        ns_server: params['ns_server']
    });

    if (simpleForm && simpleForm.classList.contains('show') && simpleForm.classList.contains('active')) {
        handleResolveSimpleMode(params);
    } else if (scopeForm && scopeForm.classList.contains('show') && scopeForm.classList.contains('active')) {
        handleResolveScopeMode(params);
    } else if (databaseForm && databaseForm.classList.contains('show') && databaseForm.classList.contains('active')) {
        handleResolveDatabaseMode(params);
    } else {
        console.error('No active tab found');
        return;
    }

    close_resolveModalWindow();
}

// Вспомогательные функции для интеграции с другими частями системы
window.resolve_script_modal_to_node = function(ip) {
    show_resolveModalWindow();
    const inputDomain = document.getElementById('resolveinput');
    if (inputDomain && ip) {
        inputDomain.value = ip;
    }
}

window.resolve_script_modal_to_info_tabs = async function(rows) {
    show_resolveModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    const uniqueDomains = [...new Set(rows
        .map(row => {
            // Предпочитаем домен, если есть, иначе IP
            return row.domain ? row.domain.trim() : (row.ipaddr ? row.ipaddr.trim() : '');
        })
        .filter(target => target !== '')
    )];
    
    console.log('Unique domains to process:', uniqueDomains);
    
    // Сбрасываем форму
    const container = document.getElementById('resolveInputContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    const originalInput = document.getElementById('resolveinput');
    if (originalInput) {
        originalInput.value = '';
    }
    
    // Заполняем поля ввода
    for (let i = 0; i < uniqueDomains.length; i++) {
        if (i === 0) {
            // Первый домен в основное поле
            const firstInput = document.getElementById('resolveinput');
            if (firstInput) {
                firstInput.value = uniqueDomains[i];
            }
        } else {
            // Остальные домены в дополнительные поля
            addNewInputForm('resolve');
            
            // Ждем обновления DOM
            await new Promise(resolve => setTimeout(resolve, 50));
            
            // Находим все input'ы и заполняем последний
            const allInputs = document.querySelectorAll('[id^="resolveinput"]');
            const lastInput = allInputs[allInputs.length - 1];
            if (lastInput) {
                lastInput.value = uniqueDomains[i];
            }
        }
    }
}

// Функция для запуска resolve задачи из database вкладки (аналогично info tabs)
window.resolve_script_modal_to_database = async function(rows) {
    show_resolveModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    // Переключаемся на database вкладку
    const databaseTab = document.getElementById('resolve-database-tab');
    if (databaseTab) {
        databaseTab.click();
        
        // Ждем переключения вкладки и инициализации таблицы
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Очищаем текущий выбор в таблице
    if (window.resolveDatabaseTargetsTable) {
        window.resolveDatabaseTargetsTable.deselectRow();
    }
    
    // Выбираем строки в таблице, соответствующие переданным rows
    if (window.resolveDatabaseTargetsTable && rows && rows.length > 0) {
        // Получаем текущие данные таблицы
        const tableData = window.resolveDatabaseTargetsTable.getData();
        console.log('Table data:', tableData);
        console.log('Rows to select:', rows);
        
        // Создаем массив для выбора строк
        const rowsToSelect = [];
        
        // Ищем соответствующие строки в таблице
        for (const row of rows) {
            const matchingRow = tableData.find(tableRow => {
                // Сравниваем по IP и домену
                const ipMatch = tableRow.ipaddr === row.ip;
                const domainMatch = tableRow.domain === row.domain;
                return ipMatch && domainMatch;
            });
            
            if (matchingRow) {
                rowsToSelect.push(matchingRow);
            }
        }
        
        // Выбираем найденные строки
        if (rowsToSelect.length > 0) {
            window.resolveDatabaseTargetsTable.selectRow(rowsToSelect);
            console.log('Selected rows in resolve database table:', rowsToSelect.length);
        } else {
            console.warn('No matching rows found in table');
        }
    }
}

// Отладочная информация
console.log('Resolve tool global functions loaded');
{% endmacro %}

{# Главный макрос resolve инструмента #}
{% macro resolve_tool_modal() %}
    {% set modal_content = resolve_form() %}
    {% set global_functions = resolve_global_functions() %}
    
    {{ base_modal(
        modal_id='resolveModalWindow',
        modal_title='Resolve Tool',
        help_url='https://help.setezor.net/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B.html#resolve',
        header_bar=tools_header_bar(prefix='resolve_'),
        content=modal_content,
        reset_function='resetResolveModal',
        custom_scripts=global_functions
    ) }}
{% endmacro %}