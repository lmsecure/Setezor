{% extends "base.html" %}
{% block title %}
Scopes
{% endblock title %}
{% block scripts %}
<link href="/static/css/src/scopes_page.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="container-fluid">
    <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#scopeAddModal" data-i18n="Add scope"></button>
    <div class="row mt-2 flex-row">
        <div class="col-3">
            <div class="mt-2">
                <table class="table table-hover w-100">
                    <thead>
                      <tr>
                        <th scope="col" style="width: 20%;" data-i18n="Name"></th>
                        <th scope="col" style="width: 60%;" data-i18n="Description"></th>
                        <th scope="col" style="width: 20%;" data-i18n="Actions"></th>
                      </tr>
                    </thead>
                </table>
                <div class="nav flex-column nav-pills" id="scopesNavPills" role="tablist" aria-orientation="vertical">
                    <!-- Скоупы -->
                </div>
            </div>
        </div>
        <div class="col-8" id="scopeTargetsContainer" style="overflow-y: auto;"></div>
        <div class="col-8" id="scopeTargetsContainer" style="overflow-y: auto;"></div>
    </div>
</div>
<div class="modal fade" id="scopeAddModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel" data-i18n="Adding scope"></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form onsubmit="addScope(event)" name="addScopeFormName">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="scopeName" class="form-label" data-i18n="Scope name"></label>
                        <input type="text" name="name" class="form-control" id="scopeName" required aria-describedby="scopeName">
                    </div>
                    <div class="mb-3">
                        <label for="scopeDescription" class="form-label" data-i18n="Scope description"></label>
                        <input type="text" name="description" class="form-control" id="scopeDescription" aria-describedby="scopeDescription">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="Close"></button>
                    <button type="submit" class="btn btn-primary" data-i18n="Add"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id = "idModalForChoosingMethodAddingTargets"> </div>
<div id="idModalForWritingTargets"> </div>
<div id="idModalForWritingDataBaseTargets"> </div>
<div id="deleteScopeModalContainer"></div>
<div id="deleteTargetModalContainer"></div>

<script>
    var message_sock = create_websocket(`/api/v1/project/ws`, '{{user_id}}');

    let currentPage = 1;
    let currentLimit = 10;
    let totalPages = 1;
    let currentScopeId = null;


    let targetsWithErrors = new Set();
    let fileTargetsCurrentPage = 1;
    let fileTargetsPageSize = 10;
    let fileTargetsTotalPages = 1;
    let fileTargetsData = [];
    let selectedTargets = new Set();
    let fileTargetsIdCounter = 0;

    async function getScopes() {
        await axios.get("/api/v1/scope").then(response => {
            let el = document.getElementById("scopesNavPills");
            let result = "";
            for (const scope of response.data) {
                result += `
                    <div class="nav-link" 
                    style="cursor: pointer;"
                    id="scope-${scope.id}-tab" data-toggle="pill" role="tab" aria-controls="scope-${scope.id}" aria-selected="false" onclick="selectScope('${scope.id}')">
                        <table style="width: 100%;">
                            <tr>
                                <td style="width: 40%; word-break: break-all;">${scope.name}</td>
                                <td style="width: 40%; word-break: break-all;">${scope.description}</td>
                                <td><div id="download_report_container">
                                    <div class="dropdown">
                                        <button class="btn btn-success mt-1" type="button"
                                            id="download_csv_scope" data-bs-toggle="dropdown" aria-expanded="false" onclick="get_csv_scope('${scope.id}', '${scope.name}')">
                                            <span class="bi bi-download"></span>
                                        </button>
                                    </div>
                                </td>
                                <td><button class="btn btn-danger mt-1" onclick="deleteScope('${scope.id}')">${i18next.t('Delete')}</button></td>
                                
                            </tr>
                        </table>
                    </div>
                `;
            }
            el.innerHTML = result;

            if (response.data.length > 0) {
                const firstScopeId = response.data[0].id;
                selectScope(firstScopeId);
            }else{
                document.getElementById("scopeTargetsContainer").innerHTML = ''
            }

            $('#scopeAddModal').modal('hide');
        });
    }

    async function get_csv_scope(scopeID, scopeName) {
        await axios.get(`/api/v1/scope/${scopeID}/download`, {responseType: 'blob'}).then(response =>{
            const blob = response.data;
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `${scopeName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        })
    }
                                                        

    async function deleteScope(scopeId) {
        let modal_elem = document.getElementById("deleteScopeModalContainer");
        modal_elem.innerHTML = `
        <div class="modal fade" id="deleteScopeModal" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${i18next.t('Removal scope')} </h5>
                    </div>
                    <div class="modal-body justify-content-center">
                        ${i18next.t('Are you sure you want to delete the scope?')}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" id="idButtonCancelModal">  ${i18next.t('Cancel')} </button>
                        <button class="btn btn-danger" type="button" data-bs-dismiss="modal" id="DeleteScopeButton"> ${i18next.t('Delete')} </button>
                    </div>
                <div>
            </div>
        </div>`
        document.getElementById("idButtonCancelModal").onclick = function () { modal_elem.innerHTML = ``; };
        document.getElementById("DeleteScopeButton").onclick = async function () {
            await axios.delete(`/api/v1/scope/${scopeId}`).then(response => {
                getScopes();
                get_nmap_scope_list();
                get_masscan_scope_list('')
                })  
            };
        let modal = new bootstrap.Modal(modal_elem.children[0]);
        modal.show()
    }

    async function deleteTarget(scopeID, targetID) {
        let modal_elem = document.getElementById("deleteTargetModalContainer");
        modal_elem.innerHTML = `
        <div class="modal fade" id="deleteTargetModal" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${i18next.t('Removal target')}</h5>
                    </div>
                    <div class="modal-body justify-content-center">
                        ${i18next.t('Are you sure you want to delete the target?')}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" id="idButtonCancelTargetDeleteModal">${i18next.t('Cancel')}</button>
                        <button class="btn btn-danger" type="button" data-bs-dismiss="modal" id="DeleteTargetButton">${i18next.t('Delete')}</button>
                    </div>
                <div>
            </div>
        </div>`
        document.getElementById("idButtonCancelTargetDeleteModal").onclick = function () { modal_elem.innerHTML = ``; };
        document.getElementById("DeleteTargetButton").onclick = async function () {
            await axios.delete(`/api/v1/target/${targetID}`).then(response => {
                getScopeTargets(scopeID);
                })  
            };
        let modal = new bootstrap.Modal(modal_elem.children[0]);
        modal.show()
    }

    function selectScope(scopeId) {
        document.querySelectorAll('#scopesNavPills .nav-link').forEach(link => {
            link.classList.remove('active');
        });

        const selectedLink = document.getElementById(`scope-${scopeId}-tab`);
        if (selectedLink) {
            selectedLink.classList.add('active');
        }

        getScopeTargets(scopeId);
    }

    getScopes();

    async function addScope(event) {
        event.preventDefault();
        let formData = new FormData(event.target);

        for (let [key, value] of formData.entries()){
            if (typeof value === 'string'){
                formData.set(key, sanitize_scope(value))
            }
        }

        await axios.post("/api/v1/scope", formData, { headers: { 'Content-Type': 'application/json' } }).then(response => {
            getScopes();
            get_nmap_scope_list();
            get_masscan_scope_list('')
        });
    }
    function sanitize_scope(string) {
			const map = {
				'&': '&amp;',
				'<': '&lt;',
				'>': '&gt;',
				'"': '&quot;',
				"'": '&#x27;',
				"/": '&#x2F;',
			};
			const reg = /[&<>"'/]/ig;
            if (string) {
				return string.replace(reg, (match) => map[match]);
			} else {
				return ""
			}
		}

    async function getScopeTargets(id, page = 1, limit = 10) {
        currentScopeId = id;
        currentPage = page;
        currentLimit = limit;
        
        let el = document.getElementById("scopeTargetsContainer");
        
        function createPageSizeSelector() {
            return `
                <div class="page-size-selector">
                    <label for="pageSize">${i18next.t('Show rows')}:</label>
                    <select id="pageSize" onchange="changePageSize(this.value)" class="form-select form-select-sm">
                        <option value="10" ${limit === 10 ? 'selected' : ''}>10</option>
                        <option value="25" ${limit === 25 ? 'selected' : ''}>25</option>
                        <option value="50" ${limit === 50 ? 'selected' : ''}>50</option>
                        <option value="100" ${limit === 100 ? 'selected' : ''}>100</option>
                    </select>
                </div>`;
        }
        
        try {
            const response = await axios.get(`/api/v1/scope/${id}/targets`, {
                params: { page, limit }
            });
            
            const { data, total, total_pages, has_next, has_prev } = response.data;
            totalPages = total_pages;
            
            let result = '';
            
            if (data.length) {
                result = `
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <button class="btn btn-success mb-2" onclick="choosingMethodAddingTargets('${id}')">
                            ${i18next.t('Add targets')}
                        </button>
                        ${createPageSizeSelector()}
                        <div class="pagination-info mb-2">
                            ${i18next.t('Showing')} ${((page - 1) * limit) + 1}-${Math.min(page * limit, total)} 
                            ${i18next.t('of')} ${total} ${i18next.t('targets')}
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead style="position: sticky; top: 0; background-color: #fff; z-index: 1;">
                                <tr>
                                    <th scope="col">${i18next.t('PROTOCOL')}</th>
                                    <th scope="col">${i18next.t('IP')}</th>
                                    <th scope="col">${i18next.t('DOMAIN')}</th>
                                    <th scope="col">${i18next.t('PORT')}</th>
                                    <th scope="col">${i18next.t('ACTION')}</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const target of data) {
                    result += `<tr id="target-${target.id}">`;
                    result += `<td><span class="editable" data-field="protocol">${sanitize_scope(target.protocol) || ''}</span></td>`;
                    result += `<td><span class="editable" data-field="ip">${target.ip || ''}</span></td>`;
                    result += `<td><span class="editable" data-field="domain">${sanitize_scope(target.domain) || ''}</span></td>`;
                    result += `<td><span class="editable" data-field="port">${target.port || ''}</span></td>`;
                    result += `<td>
                            <button class="btn btn-primary edit-btn" onclick="editTarget('${target.id}')">${i18next.t('Edit')}</button>
                            <button class="btn btn-danger delete-btn" onclick="deleteTarget('${target.scope_id}', '${target.id}')">${i18next.t('Delete')}</button>
                            <button class="btn btn-secondary cancel-btn" onclick="cancelEdit('${target.id}')" style="display:none;">${i18next.t('Cancel')}</button>
                            <button class="btn btn-success confirm-btn" onclick="confirmEdit('${target.scope_id}','${target.id}')" style="display:none;">${i18next.t('Confirm')}</button>
                    </td>`;
                    result += `</tr>`;
                }
                
                result += `</tbody></table></div>`;
                
                result += createPaginationHTML(page, total_pages, has_prev, has_next);
                
            } else {
                result = `
                    <div class="text-center">
                        <p class="mb-3">${i18next.t('No targets found')}</p>
                        <button class="btn btn-success" onclick="choosingMethodAddingTargets('${id}')">
                            ${i18next.t('Add targets')}
                        </button>
                    </div>`;
            }
            
            el.innerHTML = result;
            
        } catch (error) {
            console.error('Error loading targets:', error);
            el.innerHTML = `<div class="alert alert-danger">${i18next.t('Error loading targets')}</div>`;
        }
    }

    function createPaginationHTML(currentPage, totalPages, hasPrev, hasNext) {
        if (totalPages <= 1) return '';
        
        let paginationHTML = `
            <nav aria-label="Targets pagination" class="mt-3">
                <ul class="pagination justify-content-center flex-wrap">`;
        
        paginationHTML += `
            <li class="page-item ${!hasPrev ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage - 1})" ${!hasPrev ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> ${i18next.t('Previous')}
                </button>
            </li>`;
        
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <button class="page-link" onclick="changePage(1)">1</button>
                </li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <button class="page-link" onclick="changePage(${i})">${i}</button>
                </li>`;
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `
                <li class="page-item">
                    <button class="page-link" onclick="changePage(${totalPages})">${totalPages}</button>
                </li>`;
        }
        
        paginationHTML += `
            <li class="page-item ${!hasNext ? 'disabled' : ''}">
                <button class="page-link" onclick="changePage(${currentPage + 1})" ${!hasNext ? 'disabled' : ''}>
                    ${i18next.t('Next')} <i class="fas fa-chevron-right"></i>
                </button>
            </li>`;
        
        paginationHTML += `
                </ul>
            </nav>`;
        
        return paginationHTML;
    }

    function changePage(page) {
        if (page >= 1 && page <= totalPages && page !== currentPage) {
            getScopeTargets(currentScopeId, page, currentLimit);
        }
    }

    function changePageSize(limit) {
        currentLimit = parseInt(limit);
        getScopeTargets(currentScopeId, 1, currentLimit);
    }

    function editTarget(targetId) {
        const row = document.getElementById(`target-${targetId}`);
        const editBtn = row.querySelector('.edit-btn');
        const deleteBtn = row.querySelector('.delete-btn');
        const cancelBtn = row.querySelector('.cancel-btn');
        const confirmBtn = row.querySelector('.confirm-btn');
        const editableFields = row.querySelectorAll('.editable');

        editableFields.forEach(field => {
            const text = field.innerText;
            field.setAttribute('data-original', text);
            field.innerHTML = `<input type="text" class="form-control form-control-sm" value="${text}" />`;
        });

        editBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
        cancelBtn.style.display = 'inline-block';
        confirmBtn.style.display = 'inline-block';
    }

    function cancelEdit(targetId) {
        const row = document.getElementById(`target-${targetId}`);
        const editBtn = row.querySelector('.edit-btn');
        const deleteBtn = row.querySelector('.delete-btn');
        const cancelBtn = row.querySelector('.cancel-btn');
        const confirmBtn = row.querySelector('.confirm-btn');
        const editableFields = row.querySelectorAll('.editable');

        editableFields.forEach(field => {
            const originalValue = field.getAttribute('data-original');
            field.innerHTML = originalValue;
        });

        editBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'none';
        confirmBtn.style.display = 'none';
    }

    async function confirmEdit(scopeId, targetId) {
        const row = document.getElementById(`target-${targetId}`);
        const editBtn = row.querySelector('.edit-btn');
        const deleteBtn = row.querySelector('.delete-btn');
        const cancelBtn = row.querySelector('.cancel-btn');
        const confirmBtn = row.querySelector('.confirm-btn');
        const editableFields = row.querySelectorAll('.editable');

        const updatedData = {};

        editableFields.forEach(field => {
            const input = field.querySelector('input');
            const fieldName = field.getAttribute('data-field');
            
            if (input.value === "") {
                updatedData[fieldName] = null;
            } else {
                updatedData[fieldName] = input.value;
            }
            field.innerHTML = input.value || '';
        });

        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        confirmBtn.disabled = true;

        try {
            await axios.put(`/api/v1/target/${targetId}`, updatedData);
            
            editBtn.style.display = 'inline-block';
            deleteBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'none';
            confirmBtn.style.display = 'none';
            confirmBtn.innerHTML = i18next.t('Confirm');
            confirmBtn.disabled = false;
            
        } catch (error) {
            console.error('Error updating target:', error);
            confirmBtn.innerHTML = i18next.t('Confirm');
            confirmBtn.disabled = false;
            
            getScopeTargets(currentScopeId, currentPage, currentLimit);
        }
    }

    async function deleteTarget(scopeId, targetId) {
            const deleteBtn = document.querySelector(`#target-${targetId} .delete-btn`);
            const originalText = deleteBtn.innerHTML;
            
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            deleteBtn.disabled = true;
            
            try {
                await axios.delete(`/api/v1/target/${targetId}`);

                getScopeTargets(currentScopeId, currentPage, currentLimit);
                
            } catch (error) {
                console.error('Error deleting target:', error);
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
    }

    async function choosingMethodAddingTargets(id) {
        let modal_elem = document.getElementById("idModalForChoosingMethodAddingTargets");
        modal_elem.innerHTML = `
        <div class="modal fade" id="idModalForChoosingMethodAddingTargets2" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"> ${i18next.t('Choose method for adding targets on scope')}</h5>
                    </div>
                    <div class="modal-body justify-content-center">
                        <div class="col-1 w-100">
                            <button class="btn btn-primary m-1 w-100" type="button" data-bs-dismiss="modal" id="idButtonChoiceMethodEnterTargetsManually"> ${i18next.t('Enter targets manually')} </button>
                            <button class="btn btn-primary m-1 w-100" type="button" data-bs-dismiss="modal" id="idButtonChoiceMethodEnterTargetsFromDataBase"> ${i18next.t('Add targets from data base')} </button>
                            <button class="btn btn-primary m-1 w-100" type="button" data-bs-dismiss="modal" id="idButtonChiveMethodAddTargetsFromFile"> ${i18next.t('Add targets from file')} </button>
                        </div>
                        <span>${i18next.t("To upload a file, use the .csv format of the following type: 'Protocol, IP, Domain, Port'")}</span>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" id="idButtonCancelModalChoicingMethodAddingTargets"> ${i18next.t('Cancel')} </button>
                    </div>
                <div>
            </div>
        </div>`
        document.getElementById("idButtonCancelModalChoicingMethodAddingTargets").onclick = function () { modal_elem.innerHTML = ``; };
        document.getElementById("idButtonChoiceMethodEnterTargetsManually").onclick = async function () { await enterTargets(id); modal_elem.innerHTML = ``;  };
        document.getElementById("idButtonChoiceMethodEnterTargetsFromDataBase").onclick = async function () { await enterTargetsFromDataBase(id); modal_elem.innerHTML = ``;  };
        document.getElementById("idButtonChiveMethodAddTargetsFromFile").onclick = async function () { await addTargetsOnFile(id); modal_elem.innerHTML = ``;  };
        let modal = new bootstrap.Modal(modal_elem.children[0]);
        modal.show();
    }

    async function enterTargets(id) {
        let modal_elem = document.getElementById("idModalForWritingTargets");
        modal_elem.innerHTML = `
        <div class="modal fade" id="idModalForChoosingMethodAddingTargets2" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" style="width: 60rem;">
                    <div class="modal-header">
                        <h5 class="modal-title"> ${i18next.t('Enter targets for adding on scope')}</h5>
                    </div>
                    <div class="modal-body justify-content-center">
                        <div class="col-1 w-100">
                            <div class="input-group" style="width: calc(100% - 3rem);">
                                <span class="text" style="width: 25%;" id="target_protocol"> ${i18next.t('Protocol')} </span>
                                <span class="text" style="width: 25%;" id="target_ip"> IP </span>
                                <span class="text" style="width: 25%;" id="target_doamin"> ${i18next.t('Domain')} </span>
                                <span class="text" style="width: 25%;" id="target_port"> ${i18next.t('Port')} </span>
                            </div>
                            <div id="ScopeTargetsContainer"> </div>
                            <div class="input-group" id="idEnterScopeTargetsOriginal">
                                <datalist id="ProtocolList"></datalist>
                                <input type="text" style="margin-top: 0.5rem" list="ProtocolList" class="form-control" id="input_target_protocol" placeholder="${i18next.t('Protocol')}" aria-label="Protocol" aria-describedby="target_protocol" required name="input_target_protocol">
                                <datalist id="IPList"></datalist>
                                <input type="text" style="margin-top: 0.5rem" list="IPList" class="form-control" id="input_target_ip" placeholder="${i18next.t('IP')}" aria-label="IP" aria-describedby="target_ip" required name="input_target_ip">
                                <datalist id="DomainList"></datalist>
                                <input type="text" style="margin-top: 0.5rem" list="DomainList" class="form-control" id="input_target_domain" placeholder="${i18next.t('Domain')}" aria-label="Domain" aria-describedby="target_domain" required name="input_target_domain">
                                <datalist id="PortList"></datalist>
                                <input type="text" style="margin-top: 0.5rem" list="PortList" class="form-control" id="input_target_port" placeholder="${i18next.t('Port')}" aria-label="Port" aria-describedby="target_port" required name="input_target_port">
                                <button id="id_add_new_targets_group" onclick="addNewTargetLine()" type="button" class="btn btn-success" style="width: 3rem; margin-top: 0.5rem"> + </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" id="idButtonAddEnterTargets" onclick="addEnterTargets('${id}'); "> ${i18next.t('Add targets')} </button>
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" id="idButtonCancelModalEnterTargets"> ${i18next.t('Cancel')} </button>
                    </div>
                <div>
            </div>
        </div>`
        document.getElementById("idButtonCancelModalEnterTargets").onclick = function () { modal_elem.innerHTML = ``; };
        let modal = new bootstrap.Modal(modal_elem.children[0]);
        modal.show();
    }
    async function enterTargetsFromDataBase(id) {
        let modal_elem = document.getElementById("idModalForWritingDataBaseTargets");
        modal_elem.innerHTML = `
        <div class="modal fade" id="idModalForChoosingMethodAddingTargets2" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content" style="width: 60rem;">
                    <div class="modal-header">
                        <h5 class="modal-title"> ${i18next.t('Enter targets for adding on scope')} </h5>
                    </div>
                    <div class="modal-body justify-content-center">
                        <div class="w-100">
                            <div class="container">
                                <div class="btn-group row row-cols-3 g-2 p-1 w-100" id="IpsDomainsDropdown">
                                    <button type="button" class="btn btn-outline-primary dropdown-toggle" style="flex: none" data-bs-toggle="dropdown" aria-expanded="false">
                                        ${i18next.t('Select targets')}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" data-value="IP">${i18next.t('IP')}</a></li>
                                        <li><a class="dropdown-item" href="#" data-value="IP:Port">${i18next.t('IP-Port')}</a></li>
                                        <li><a class="dropdown-item" href="#" data-value="Domains">${i18next.t('Domains')}</a></li>
                                    </ul>
                                    <div class="form-check ms-3" >
                                        <input class="form-check-input" type="checkbox" id="selectAllTargets">
                                        <label class="form-check-label" for="selectAllTargets">
                                            ${i18next.t('Select All')}
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div id="DataBaseTargetsContainer" class="row row-cols-3 g-2 p-1" style="max-height: 400px; overflow-y: auto;"> </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" id="idButtonAddEnterTargets" onclick="processSelectedItems('${id}'); getElementById('idButtonCancelModalEnterTargets').click(); ">  ${i18next.t('Add targets')} </button>
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal" id="idButtonCancelModalEnterTargets"> ${i18next.t('Cancel')} </button>
                    </div>
                <div>
            </div>
        </div>`
        document.getElementById("idButtonCancelModalEnterTargets").onclick = function () { modal_elem.innerHTML = ``; };
        const selectAllCheckbox = document.getElementById('selectAllTargets');
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#DataBaseTargetsContainer input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
            });
        });
        let modal = new bootstrap.Modal(modal_elem.children[0]);
        modal.show();
        getDataBaseTargets();
    }


    function getDataBaseTargets() {
            let dropdown = document.getElementById('IpsDomainsDropdown');
            let dropdownItems = dropdown.querySelectorAll('.dropdown-item');
            let dropdownButton = dropdown.querySelector('.dropdown-toggle');
            let resultContainer = document.getElementById('DataBaseTargetsContainer');

            dropdownItems.forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();

                    let selectedValue = this.getAttribute('data-value')
                    dropdownButton.textContent = selectedValue

                    if (selectedValue === 'IP'){
                        await axios.get(`/api/v1/target/get_ips`).then(response => {
                            resultContainer.innerHTML = ``
                            response.data.forEach(ip => {
                                resultContainer.innerHTML += ` <div class="col md-1">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" value="" id="${ip}">
                                                                    <label class="form-check-label" for="${ip}">
                                                                        ${ip}
                                                                    </label>
                                                                </div>
                                                                </div>`
                            })
                        });
                    } else if (selectedValue === 'Domains'){
                        resultContainer.innerHTML = ``
                        await axios.get(`/api/v1/target/get_domains`).then(response => {
                            response.data.forEach(domain => {
                                resultContainer.innerHTML += `<div class="form-check">
                                                                <input class="form-check-input" type="checkbox" value="" id="${domain}">
                                                                <label class="form-check-label" for="${domain}">
                                                                    ${domain}
                                                                </label>
                                                                </div>`
                            })
                        })
                    }   else if (selectedValue === 'IP:Port'){
                        resultContainer.innerHTML = ``
                        await axios.get(`/api/v1/target/get_ips_ports`).then(response => {
                            response.data.forEach(ip_port => {
                                resultContainer.innerHTML += `<div class="form-check">
                                                                <input class="form-check-input" type="checkbox" value="" id="${ip_port.ip}_${ip_port.port}">
                                                                <label class="form-check-label" for="${ip_port.ip}_${ip_port.port}">
                                                                    ${ip_port.ip}:${ip_port.port}
                                                                </label>
                                                                </div>`
                            })
                        })
                    }
            })
            })
        }

    async function processSelectedItems(id) {
        let target_type = document.getElementById('IpsDomainsDropdown').textContent.split('\n')[1].replaceAll(' ', '');
        let targets = [];
        document.querySelectorAll('#DataBaseTargetsContainer input[type="checkbox"]:checked').forEach(checkbox => {
            if (target_type === "IP") {
                targets.push({
                    "protocol" : null,
                    "ip" : checkbox.id || null,
                    "domain" : null,
                    "port" : null
                })
            }
            if (target_type === "Domains") {
                targets.push({
                    "protocol" : null,
                    "ip" : null,
                    "domain" : checkbox.id || null,
                    "port" : null
                })
            }
            if (target_type === "IP:Port") {
                ip_port = checkbox.id.split('_')
                targets.push({
                    "protocol" : null,
                    "ip" : ip_port[0],
                    "domain" : null,
                    "port" : ip_port[1]
                })
            }
        })
        await axios.post(`/api/v1/scope/${id}/targets`, {targets: targets}, {headers: {'Content-Type': 'application/json'}}).then(response =>{
            getScopeTargets(id)
        })
    }

    async function addNewTargetLine(){
        let suffix_id = Date.now();
        let original = document.getElementById('idEnterScopeTargetsOriginal');
        let clone = original.cloneNode(true);
        
        let newInputProtocol = clone.querySelector('[id^=input_target_protocol]');
        newInputProtocol.id = 'input_target_protocol_' + suffix_id;
        let originalInputProtocol = document.getElementById('input_target_protocol');
        newInputProtocol.value = originalInputProtocol.value;
        originalInputProtocol.value = ''

        let newInputIP = clone.querySelector('[id^=input_target_ip]');
        newInputIP.id = 'input_target_ip_' + suffix_id;
        let originalInputIP = document.getElementById('input_target_ip');
        newInputIP.value = originalInputIP.value;
        originalInputIP.value = ''

        let newInputDomain = clone.querySelector('[id^=input_target_domain]');
        newInputDomain.id = 'input_target_domain_' + suffix_id;
        let originalInputDomain = document.getElementById('input_target_domain');
        newInputDomain.value = originalInputDomain.value;
        originalInputDomain.value = ''

        let newInputPort = clone.querySelector('[id^=input_target_port]');
        newInputPort.id = 'input_target_port_' + suffix_id;
        let originalInputPort = document.getElementById('input_target_port');
        newInputPort.value = originalInputPort.value;
        originalInputPort.value = ''

        let existingMinusButton = clone.querySelector('.btn-danger');
        if (existingMinusButton) {
            existingMinusButton.remove();
        }
        let removeButton = document.createElement('button');
        removeButton.textContent = '-';
        removeButton.type = 'button';
        removeButton.className = 'btn btn-danger';
        removeButton.style.width = '3rem';
        removeButton.style.marginTop = '0.5rem';
        removeButton.onclick = () => {
            clone.remove();
        };
        clone.appendChild(removeButton);
        let addButton = clone.querySelector('#id_add_new_targets_group');
        if (addButton) {
            addButton.remove();
        }
        document.getElementById('ScopeTargetsContainer').appendChild(clone);
    }

    
    async function addEnterTargets(id) {
        try {
            const targetsProtocol = document.querySelectorAll('[id^="input_target_protocol"]');
            const targetsIP = document.querySelectorAll('[id^="input_target_ip"]');
            const targetsDomain = document.querySelectorAll('[id^="input_target_domain"]');
            const targetsPort = document.querySelectorAll('[id^="input_target_port"]');
            
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

            let hasErrors = false;
            let targets = [];
            
            for (let i = 0; i < targetsProtocol.length; i++) {
                const protocol = targetsProtocol[i].value.trim();
                const ip = targetsIP[i].value.trim();
                const domain = targetsDomain[i].value.trim();
                const port = targetsPort[i].value.trim();
                
                if (!protocol && !ip && !domain && !port) {
                    continue;
                }

                if (protocol && !/^[a-zA-Z]+$/.test(protocol)) {
                    markInputAsInvalid(targetsProtocol[i], "Protocol should contain only letters");
                    hasErrors = true;
                }
                
                if (ip && !isValidIP(ip)) {
                    markInputAsInvalid(targetsIP[i], "Invalid IP address format");
                    hasErrors = true;
                }
                
                if (domain && !isValidDomain(domain)) {
                    markInputAsInvalid(targetsDomain[i], "Invalid domain format");
                    hasErrors = true;
                }
                
                if (port) {
                    const portNum = Number(port);
                    if (isNaN(portNum)) {
                        markInputAsInvalid(targetsPort[i], "Port must be a number");
                        hasErrors = true;
                    } else if (portNum < 1 || portNum > 65535) {
                        markInputAsInvalid(targetsPort[i], "Port must be between 1 and 65535");
                        hasErrors = true;
                    }
                }
                
                if (hasErrors) continue;
                targets.push({
                    "protocol": protocol || null,
                    "ip": ip || null,
                    "domain": domain || null,
                    "port": port ? Number(port) : null
                });
            }
            
            if (hasErrors) {
                create_toast("Error", "Please correct the errors in the form", "error");
                return;
            }
            
            if (targets.length === 0) {
                create_toast("Error", "No valid targets to add", "error");
                return;
            }
            
            const response = await axios.post(
                `/api/v1/scope/${id}/targets`, 
                {targets: targets}, 
                {headers: {'Content-Type': 'application/json'}}
            );
            
            if (response.status >= 200 && response.status < 300) {
                document.getElementById('idButtonCancelModalEnterTargets').click();
                getScopeTargets(id);
                create_toast("Success", "Targets added successfully", "success");
            } 
        } catch (error) {
            if (error.response?.status === 422) {
                const errors = error.response.data.detail;
                if (Array.isArray(errors)) {
                    errors.forEach(err => {
                        const input = document.querySelector(`[name="${err.loc[1]}"]`);
                        if (input) markInputAsInvalid(input, err.msg);
                    });
                }
                create_toast("Error", "Please check the correctness of the entered data", "error");
            } else {
                create_toast("Error", error.response?.data?.detail || "An error occurred", "error");
            }
        }
    }

    function isValidIP(ip) {
        const ipv4WithCidrRegex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\/([0-9]|[1-2][0-9]|3[0-2])$/;
        const ipv6WithCidrRegex = /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\/([0-9]|[1-9][0-9]|1[0-2][0-8])$/;
        const ipv4Regex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        const ipv6Regex = /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;
        
        return ipv4WithCidrRegex.test(ip) || 
            ipv6WithCidrRegex.test(ip) || 
            ipv4Regex.test(ip) || 
            ipv6Regex.test(ip);
    }

    function isValidDomain(domain) {
        const domainRegex = /^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i;
        return domainRegex.test(domain);
    }

    function markInputAsInvalid(inputElement, errorMessage) {
        inputElement.classList.add('is-invalid');
    }

    async function addTargetsOnFile(id) {
        var input = document.createElement('input');
        input.type = 'file';
        input.multiple = false;
        input.accept = '.csv';
        input.onchange = async (e) => {
            for (var file of e.target.files) {
                var reader = new FileReader();
                reader.onload = (function (file) {
                    return async function (e) {
                        let content = e.target.result;
                        content = content.split("base64,")[1];
                        let decodedString = atob(content);

                        fileTargetsData = [];
                        selectedTargets.clear();
                        fileTargetsIdCounter = 0;
                        
                        for (let line of decodedString.split("\n")) {
                            if (line.trim() !== "") {
                                let splitted_line = line.split(",");
                                if (splitted_line.length >= 4) {
                                    const targetId = generateUniqueId();
                                    fileTargetsData.push({
                                        id: targetId,
                                        protocol: splitted_line[0]?.trim() || '',
                                        ip: splitted_line[1]?.trim() || '',
                                        domain: splitted_line[2]?.trim() || '',
                                        port: splitted_line[3]?.trim() || '',
                                        isEditing: false,
                                        originalLine: line
                                    });
                                }
                            }
                        }

                        fileTargetsCurrentPage = 1;
                        fileTargetsTotalPages = Math.ceil(fileTargetsData.length / fileTargetsPageSize);
                        displayFileTargetsPage(id);
                    };
                })(file);
                reader.onerror = (function (file) {
                    return function (e) {
                        create_toast('Error', `Not enough permissions. Check file owner`, 'error')
                    }
                })(file)
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }


    function updateSelectedTargetsAfterEdit(oldId, newId) {
        if (selectedTargets.has(oldId)) {
            selectedTargets.delete(oldId);
            selectedTargets.add(newId);
        }
    }
    function generateUniqueId() {
        return 'file-target-' + (++fileTargetsIdCounter) + '-' + Date.now();
    }

    let fileTargetsModal = null;

    function displayFileTargetsPage(id) {
        let modal_elem = document.getElementById("idModalForWritingTargets");
        
        modal_elem.innerHTML = '';
        
        let startIdx = (fileTargetsCurrentPage - 1) * fileTargetsPageSize;
        let endIdx = startIdx + fileTargetsPageSize;
        let pageData = fileTargetsData.slice(startIdx, endIdx);

        modal_elem.innerHTML = `
        <div class="modal fade" id="idModalForChoosingMethodAddingTargets2" data-bs-backdrop="static" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${i18next.t('Targets from file')} (${fileTargetsData.length} ${i18next.t('targets')}, ${selectedTargets.size} ${i18next.t('selected')})</h5>
                    </div>
                    <div class="modal-body">
                        
                        ${targetsWithErrors.size > 0 ? `
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i>
                            ${i18next.t('some targets have validation errors and are highlighted in red')}
                            </div>
                        ` : ''}
                        
                        <div class="d-flex justify-content-between mb-3">
                            <div class="page-size-selector">
                                <label for="filePageSize">${i18next.t('Show rows')}:</label>
                                <select id="filePageSize" onchange="changeFilePageSize(this.value, '${id}')" class="form-select form-select-sm">
                                    <option value="10" ${fileTargetsPageSize === 10 ? 'selected' : ''}>10</option>
                                    <option value="25" ${fileTargetsPageSize === 25 ? 'selected' : ''}>25</option>
                                    <option value="50" ${fileTargetsPageSize === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${fileTargetsPageSize === 100 ? 'selected' : ''}>100</option>
                                </select>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                    <input class="form-check-input" type="checkbox" id="selectAllCurrentPage" 
                                        onchange="toggleSelectAllCurrentPage(this.checked, '${id}')"
                                        ${pageData.every(t => selectedTargets.has(t.id)) ? 'checked' : ''}>
                                    <label class="form-check-label" for="selectAllCurrentPage">
                                        ${i18next.t('Select current page targets')}
                                    </label>
                                </div>
                                <div class="pagination-info">
                                    ${i18next.t('Showing')} ${startIdx + 1}-${Math.min(endIdx, fileTargetsData.length)} 
                                    ${i18next.t('of')} ${fileTargetsData.length} ${i18next.t('targets')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><!-- Checkbox column --></th>
                                        <th>${i18next.t('Protocol')}</th>
                                        <th>${i18next.t('IP')}</th>
                                        <th>${i18next.t('Domain')}</th>
                                        <th>${i18next.t('Port')}</th>
                                        <th>${i18next.t('Actions')}</th>
                                    </tr>
                                </thead>
                                <tbody id="fileTargetsTableBody">
                                    ${pageData.map(target => {
                                        const hasError = targetsWithErrors.has(target.id);
                                        return `
                                        <tr id="${target.id}" ${hasError ? 'class="table-error-row"' : ''}>
                                            <td>
                                                <input type="checkbox" class="target-checkbox" 
                                                    onchange="toggleTargetSelection('${target.id}', this.checked, '${id}')"
                                                    ${selectedTargets.has(target.id) ? 'checked' : ''}>
                                                ${hasError ? '<i class="fas fa-exclamation-triangle error-icon error-tooltip"></i>' : ''}
                                            </td>
                                            ${target.isEditing ? `
                                                <td><input type="text" class="form-control form-control-sm ${hasError ? 'is-invalid' : ''}" value="${target.protocol}" data-field="protocol"></td>
                                                <td><input type="text" class="form-control form-control-sm ${hasError ? 'is-invalid' : ''}" value="${target.ip}" data-field="ip"></td>
                                                <td><input type="text" class="form-control form-control-sm ${hasError ? 'is-invalid' : ''}" value="${target.domain}" data-field="domain"></td>
                                                <td><input type="text" class="form-control form-control-sm ${hasError ? 'is-invalid' : ''}" value="${target.port}" data-field="port"></td>
                                                <td>
                                                    <button class="btn btn-success btn-sm" onclick="saveFileTargetEdit('${target.id}', '${id}')">${i18next.t('Save')}</button>
                                                    <button class="btn btn-secondary btn-sm" onclick="cancelFileTargetEdit('${target.id}', '${id}')">${i18next.t('Cancel')}</button>
                                                </td>
                                            ` : `
                                                <td>${target.protocol}</td>
                                                <td>${target.ip}</td>
                                                <td>${target.domain}</td>
                                                <td>${target.port}</td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm" onclick="editFileTarget('${target.id}', '${id}')">${i18next.t('Edit')}</button>
                                                    <button class="btn btn-danger btn-sm" onclick="removeFileTarget('${target.id}', '${id}')">${i18next.t('Remove')}</button>
                                                </td>
                                            `}
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${createFilePaginationHTML()}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-success" onclick="addSelectedFileTargets('${id}')" ${selectedTargets.size === 0 ? 'disabled' : ''}>
                            ${i18next.t('Add selected targets')} (${selectedTargets.size})
                        </button>
                        <button class="btn btn-primary" onclick="addCurrentPageTargets('${id}')">
                            ${i18next.t('Add current page targets')} (${pageData.length})
                        </button>
                        <button class="btn btn-info" onclick="addAllFileTargets('${id}')">
                            ${i18next.t('Add all targets')} (${fileTargetsData.length})
                        </button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">${i18next.t('Cancel')}</button>
                    </div>
                </div>
            </div>
        </div>`;

        if (fileTargetsModal) {
            fileTargetsModal.hide();
        }
        
        fileTargetsModal = new bootstrap.Modal(modal_elem.children[0]);
        fileTargetsModal.show();
    }

    function clearTargetError(targetId, id) {
        targetsWithErrors.delete(targetId);
        displayFileTargetsPage(id);
    }

    function clearAllErrors(id) {
        targetsWithErrors.clear();
        displayFileTargetsPage(id);
    }


    async function addAllFileTargets(id) {
        try {
            await processFileTargets(id, fileTargetsData);
            selectedTargets.clear();
        } catch (error) {
            console.error('Error in addSelectedFileTargets:', error);
        }
    }

    function toggleTargetSelection(targetId, isChecked, scopeId) {
        if (isChecked) {
            selectedTargets.add(targetId);
        } else {
            selectedTargets.delete(targetId);
        }
        const modalTitle = document.querySelector('#idModalForChoosingMethodAddingTargets2 .modal-title');
        if (modalTitle) {
            modalTitle.textContent = `${i18next.t('Targets from file')} (${fileTargetsData.length} ${i18next.t('targets')}, ${selectedTargets.size} ${i18next.t('selected')})`;
        }
        const addSelectedBtn = document.querySelector('#idModalForChoosingMethodAddingTargets2 .btn-success');
        if (addSelectedBtn) {
            addSelectedBtn.disabled = selectedTargets.size === 0;
            addSelectedBtn.textContent = `${i18next.t('Add selected targets')} (${selectedTargets.size})`;
        }
        updateSelectAllCurrentPageCheckbox(scopeId);
    }

    async function addSelectedFileTargets(id) {
        const selectedData = fileTargetsData.filter(target => selectedTargets.has(target.id));
        try {
            await processFileTargets(id, selectedData);
            selectedTargets.clear();
        } catch (error) {
            console.error('Error in addSelectedFileTargets:', error);
        }
    }


    function toggleSelectAllCurrentPage(isChecked, scopeId) {
        const startIdx = (fileTargetsCurrentPage - 1) * fileTargetsPageSize;
        const endIdx = startIdx + fileTargetsPageSize;
        const pageData = fileTargetsData.slice(startIdx, endIdx);

        pageData.forEach(target => {
            if (isChecked) {
                selectedTargets.add(target.id);
            } else {
                selectedTargets.delete(target.id);
            }
        });

        displayFileTargetsPage(scopeId);
    }

    function updateSelectAllCurrentPageCheckbox(scopeId) {
        const startIdx = (fileTargetsCurrentPage - 1) * fileTargetsPageSize;
        const endIdx = startIdx + fileTargetsPageSize;
        const pageData = fileTargetsData.slice(startIdx, endIdx);
        const allSelected = pageData.length > 0 && pageData.every(t => selectedTargets.has(t.id));
        
        const selectAllCheckbox = document.getElementById('selectAllCurrentPage');
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = allSelected;
        }
    }


    function editFileTarget(targetId, scopeId) {
        const targetIndex = fileTargetsData.findIndex(t => t.id === targetId);
        if (targetIndex !== -1) {
            const newId = generateUniqueId();
            const editedTarget = {
                ...fileTargetsData[targetIndex],
                id: newId,
                isEditing: true,
                originalData: { ...fileTargetsData[targetIndex] }
            };
            
            fileTargetsData[targetIndex] = editedTarget;
            
            updateSelectedTargetsAfterEdit(targetId, newId);
            
            displayFileTargetsPage(scopeId);
        }
    }

    function cancelFileTargetEdit(targetId, scopeId) {
        const targetIndex = fileTargetsData.findIndex(t => t.id === targetId);
        if (targetIndex !== -1 && fileTargetsData[targetIndex].originalData) {
            fileTargetsData[targetIndex] = {
                ...fileTargetsData[targetIndex].originalData,
                isEditing: false
            };
            
            displayFileTargetsPage(scopeId);
        }
    }

    function saveFileTargetEdit(targetId, scopeId) {
        const targetIndex = fileTargetsData.findIndex(t => t.id === targetId);
        if (targetIndex !== -1) {
            const row = document.getElementById(targetId);
            const inputs = row.querySelectorAll('input[data-field]');
            
            const newId = generateUniqueId();
            const updatedTarget = {
                ...fileTargetsData[targetIndex],
                id: newId,
                isEditing: false
            };
            
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                updatedTarget[field] = input.value.trim();
            });
            
            fileTargetsData[targetIndex] = updatedTarget;
            
            updateSelectedTargetsAfterEdit(targetId, newId);
            
            displayFileTargetsPage(scopeId);
        }
    }

    function removeFileTarget(targetId, scopeId) {
        selectedTargets.delete(targetId);
        
        fileTargetsData = fileTargetsData.filter(t => t.id !== targetId);
        fileTargetsTotalPages = Math.ceil(fileTargetsData.length / fileTargetsPageSize);
        
        if (fileTargetsCurrentPage > fileTargetsTotalPages && fileTargetsTotalPages > 0) {
            fileTargetsCurrentPage = fileTargetsTotalPages;
        }
        
        displayFileTargetsPage(scopeId);
    }

    function createFilePaginationHTML() {
        if (fileTargetsTotalPages <= 1) return '';
        
        let paginationHTML = `
            <nav aria-label="File targets pagination" class="mt-3">
                <ul class="pagination justify-content-center flex-wrap">`;
        
        paginationHTML += `
            <li class="page-item ${fileTargetsCurrentPage === 1 ? 'disabled' : ''}">
                <button class="page-link" onclick="changeFilePage(${fileTargetsCurrentPage - 1})" ${fileTargetsCurrentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> ${i18next.t('Previous')}
                </button>
            </li>`;
        
        const startPage = Math.max(1, fileTargetsCurrentPage - 2);
        const endPage = Math.min(fileTargetsTotalPages, fileTargetsCurrentPage + 2);
        
        if (startPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <button class="page-link" onclick="changeFilePage(1)">1</button>
                </li>`;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === fileTargetsCurrentPage ? 'active' : ''}">
                    <button class="page-link" onclick="changeFilePage(${i})">${i}</button>
                </li>`;
        }
        
        if (endPage < fileTargetsTotalPages) {
            if (endPage < fileTargetsTotalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `
                <li class="page-item">
                    <button class="page-link" onclick="changeFilePage(${fileTargetsTotalPages})">${fileTargetsTotalPages}</button>
                </li>`;
        }
        
        paginationHTML += `
            <li class="page-item ${fileTargetsCurrentPage === fileTargetsTotalPages ? 'disabled' : ''}">
                <button class="page-link" onclick="changeFilePage(${fileTargetsCurrentPage + 1})" ${fileTargetsCurrentPage === fileTargetsTotalPages ? 'disabled' : ''}>
                    ${i18next.t('Next')} <i class="fas fa-chevron-right"></i>
                </button>
            </li>`;
        
        paginationHTML += `
                </ul>
            </nav>`;
        
        return paginationHTML;
    }

    function changeFilePage(page) {
        if (page >= 1 && page <= fileTargetsTotalPages && page !== fileTargetsCurrentPage) {
            fileTargetsCurrentPage = page;
            displayFileTargetsPage(currentScopeId);
        }
    }

    function changeFilePageSize(size, id) {
        fileTargetsPageSize = parseInt(size);
        fileTargetsTotalPages = Math.ceil(fileTargetsData.length / fileTargetsPageSize);
        fileTargetsCurrentPage = 1;
        displayFileTargetsPage(id);
    }

    async function addCurrentPageTargets(id) {
        const startIdx = (fileTargetsCurrentPage - 1) * fileTargetsPageSize;
        const endIdx = startIdx + fileTargetsPageSize;
        const pageData = fileTargetsData.slice(startIdx, endIdx);
        await processFileTargets(id, pageData);
    }


    async function processFileTargets(id, targets) {
        try {
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
            
            let hasErrors = false;
            const formattedTargets = [];
            const currentErrorTargets = new Set();
            
            for (const target of targets) {
            const protocol = target.protocol ? target.protocol.trim() : '';
            const ip = target.ip ? target.ip.trim() : '';
            const domain = target.domain ? target.domain.trim() : '';
            const port = target.port ? target.port.toString().trim() : '';
            
            let targetHasError = false;
            
            if (!protocol && !ip && !domain && !port) {
                continue;
            }
            
            if (protocol && !/^[a-zA-Z]+$/.test(protocol)) {
                hasErrors = true;
                targetHasError = true;
            }
            
            if (ip && !isValidIP(ip)) {
                hasErrors = true;
                targetHasError = true;
            }
            
            if (domain && !isValidDomain(domain)) {
                hasErrors = true;
                targetHasError = true;
            }
            
            if (port) {
                const portNum = Number(port);
                if (isNaN(portNum)) {
                console.error(`Port must be a number: ${port}`);
                hasErrors = true;
                targetHasError = true;
                } else if (portNum < 1 || portNum > 65535) {
                console.error(`Port must be between 1 and 65535: ${port}`);
                hasErrors = true;
                targetHasError = true;
                }
            }
            
            if (targetHasError) {
                currentErrorTargets.add(target.id);
            } else {
                formattedTargets.push({
                protocol: protocol || null,
                ip: ip || null,
                domain: domain || null,
                port: port ? Number(port) : null
                });
            }
            }
            
            if (hasErrors) {
            targetsWithErrors = new Set([...targetsWithErrors, ...currentErrorTargets]);
            
            displayFileTargetsPage(id);
            
            create_toast("Error", "Some targets have invalid format and were skipped", "error");
            throw new Error("Invalid target format");
            }
            
            if (formattedTargets.length === 0) {
            create_toast("Error", "No valid targets to add", "error");
            throw new Error("No valid targets");
            }
            
            const response = await axios.post(
            `/api/v1/scope/${id}/targets`,
            {targets: formattedTargets},
            {headers: {'Content-Type': 'application/json'}}
            );
            
            if (response.status >= 200 && response.status < 300) {
            targetsWithErrors.clear();
            
            document.querySelector('#idModalForWritingTargets .btn-secondary').click();
            getScopeTargets(id);
            create_toast("Success", `${formattedTargets.length} targets added successfully`, "success");
            }
            
        } catch (error) {
            console.error('Error adding targets:', error);
            if (error.response?.status === 422) {
            const errors = error.response.data.detail;
            if (Array.isArray(errors)) {
                errors.forEach(err => {
                console.error(`Validation error: ${err.loc[1]} - ${err.msg}`);
                });
            }
            create_toast("Error", "Please check the correctness of the entered data", "error");
            } else {
            create_toast("Error", error.response?.data?.detail || "An error occurred", "error");
            }
            throw error;
        }
    }

</script>
{% endblock content %}