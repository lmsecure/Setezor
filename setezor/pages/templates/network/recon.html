{% from "modals/base_modal_framework.html" import tools_header_bar, target_scope_database_tabs, base_input, base_scope, base_database_content, base_modal %}

{# Специфичная логика для recon инструмента - основная часть #}
{% macro recon_main_content() %}
{# Поле для ввода NS серверов #}
<div class="mt-3">
    <label for="reconNsServer" class="form-label" data-i18n="NS Servers"></label>
    <input type="text" class="form-control" id="reconNsServer" name="ns_server" 
           placeholder="8.8.8.8, 1.1.1.1" data-bs-toggle="tooltip"
           data-bs-placement="top" data-i18n-title="Optional: Specify nameservers (comma separated)">
    <div class="form-text" data-i18n="Optional: Specify custom nameservers for DNS queries (comma separated)">
    </div>
</div>

<hr class="my-3 bg-secondary">
<div class="btn-group d-flex my-2" role="group">
    <input class="btn btn-outline-secondary w-50" name="reset_params" type="reset" data-i18n="Reset Params">
    <button type="button" class="btn btn-primary w-50" id="startreconFind" 
            onclick="processreconTask()" data-i18n="Start"></button>
</div>
{% endmacro %}

{# Форма recon инструмента #}
{% macro recon_form() %}
<form id="reconForm" name="reconFormName" class="needs-validation" novalidate>
    {{ target_scope_database_tabs(
        prefix='recon-',
        simple_content=base_input(prefix='recon', placeholder_i18n='Domain name'),
        scope_content=base_scope(prefix='recon-'),
        database_content=base_database_content(
            prefix='recon-',
            table_id='reconDatabaseTargetsTable',
            selected_targets_var='selectedreconTargets'
        )
    ) }}
    {{ recon_main_content() }}
</form>
{% endmacro %}

{# Глобальные функции для recon tool #}
{% macro recon_global_functions() %}
window.show_reconModalWindow = function() {
    console.log('show_reconModalWindow called');
    resetreconModal();
    const myModal = new bootstrap.Modal(document.getElementById('reconModalWindow'));
    myModal.show();
    
    // Инициализируем таблицу при открытии модалки
    setTimeout(() => {
        initreconDatabase();
        // Загружаем список scope
        get_scope_list('recon-');
    }, 100);
}

window.close_reconModalWindow = function() {
    const myModal = bootstrap.Modal.getInstance(document.getElementById('reconModalWindow'));
    if (myModal) {
        myModal.hide();
    }
}

// Функция сброса для recon модального окна
window.resetreconModal = function() {
    const reconForm = document.getElementById('reconForm');
    if (reconForm) reconForm.reset();

    const container = document.getElementById('reconInputContainer');
    if (container) container.innerHTML = '';

    const originalInput = document.getElementById('reconinput');
    if (originalInput) originalInput.value = '';

    const nsServerInput = document.getElementById('reconNsServer');
    if (nsServerInput) nsServerInput.value = '';

    const dropdownButton = document.getElementById('recon-ScopeDropdown');
    if (dropdownButton) dropdownButton.textContent = 'Select scope';
    
    window['selectedScope_recon-'] = '';
    window.selectedreconTargets = {};

    // Сброс вкладок
    const simpleTab = document.getElementById('recon-simple-tab');
    const scopeTab = document.getElementById('recon-scope-tab');
    const databaseTab = document.getElementById('recon-database-tab');
    const simpleMode = document.getElementById('recon-simple-mode');
    const scopeMode = document.getElementById('recon-scope-mode');
    const databaseMode = document.getElementById('recon-database-mode');
    
    if (simpleTab && scopeTab && databaseTab && simpleMode && scopeMode && databaseMode) {
        simpleTab.classList.add('active');
        scopeTab.classList.remove('active');
        databaseTab.classList.remove('active');
        simpleMode.classList.add('show', 'active');
        scopeMode.classList.remove('show', 'active');
        databaseMode.classList.remove('show', 'active');
    }
    
    // Очищаем выбор в таблице
    if (window.reconDatabaseTargetsTable && typeof window.reconDatabaseTargetsTable.deselectRow === 'function') {
        window.reconDatabaseTargetsTable.deselectRow();
    }
}

// Инициализация таблицы при открытии модалки
window.initreconDatabase = function() {
    window.reconDatabaseTargetsTable = initDatabaseTable(
        'reconDatabaseTargetsTable', 
        'selectedreconTargets', 
        'recon-SelectedCount'
    );
    
    // Добавляем обработчик для rowSelectionChanged
    if (window.reconDatabaseTargetsTable) {
        window.reconDatabaseTargetsTable.on("rowSelectionChanged", function(data, rows) {
            console.log('Row selection changed:', rows.length, 'rows selected');
            window.selectedreconTargets = {};
            
            rows.forEach(row => {
                const rowData = row.getData();
                const uniqueKey = `${rowData.ipaddr}:${rowData.domain}`;
                window.selectedreconTargets[uniqueKey] = {
                    ip: rowData.ipaddr,
                    domain: rowData.domain,
                    port: rowData.port
                };
            });
            
            console.log('Updated selectedreconTargets:', window.selectedreconTargets);
        });
    }
}

// Бизнес-логика recon инструмента
window.sendDnsTask = function(params) {
    console.log('Sending DNS task:', params);
    fetch('/api/v1/task/dns_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(params)
    }).then(response => {
        console.log('DNS task response:', response.status);
    }).catch(error => {
        console.error('DNS task error:', error);
    });
}

window.handlereconSimpleMode = function(params) {
    const recons = [];
    const reconInputs = document.querySelectorAll('#reconForm [id^="reconinput"]');
    
    for (const input of reconInputs) {
        if (input.value.trim() !== '') {
            recons.push(input.value);
        }
    }

    console.log('Processing simple mode recons:', recons);

    for (const recon of recons) {
        const reconParams = {
            ...params,
            domain: recon,
            agent_id: getAgent()
        };

        sendDnsTask(reconParams);
    }
}

window.handlereconScopeMode = function(params) {
    if (!window['selectedScope_recon-'] || window['selectedScope_recon-'] === '') {
        return;
    }
    
    params['scope_id'] = window['selectedScope_recon-'];
    params['agent_id'] = getAgent();

    console.log('Processing scope mode with scope ID:', window['selectedScope_recon-']);

    sendDnsTask(params);
}

window.handlereconDatabaseMode = function(params) {
    // Проверяем, что есть выбранные цели
    if (!window.selectedreconTargets || Object.keys(window.selectedreconTargets).length === 0) {
        return;
    }
    
    const targets = Object.values(window.selectedreconTargets);
    
    console.log('Processing database targets:', targets);
    
    // Собираем уникальные домены из выбранных целей
    const uniquerecons = new Set();
    
    for (const target of targets) {
        // Используем domain если есть, иначе ip
        const reconValue = target.domain || target.ip;
        if (reconValue && reconValue.trim() !== '') {
            uniquerecons.add(reconValue.trim());
        }
    }
    
    const reconsArray = Array.from(uniquerecons);
    console.log('Unique recons from database selection:', reconsArray);
    
    if (reconsArray.length === 0) {
        return;
    }
    
    // Отправляем задачи для каждого уникального домена
    for (const recon of reconsArray) {
        const reconParams = {
            ...params,
            domain: recon,
            agent_id: getAgent()
        };

        console.log('Sending task for recon:', recon, 'with params:', reconParams);
        
        sendDnsTask(reconParams);
    }
}

window.processreconTask = function() {
    const params = {};
    const nsServerInput = document.getElementById('reconNsServer');
    
    // Добавляем NS серверы если указаны
    if (nsServerInput && nsServerInput.value.trim() !== '') {
        params['ns_server'] = nsServerInput.value.trim().split(',').map(item => item.trim());
        console.log('Using custom NS servers:', params['ns_server']);
    }

    const simpleForm = document.getElementById('recon-simple-mode');
    const scopeForm = document.getElementById('recon-scope-mode');
    const databaseForm = document.getElementById('recon-database-mode');

    console.log('Processing recon task with mode:', {
        simple: simpleForm?.classList.contains('show') && simpleForm.classList.contains('active'),
        scope: scopeForm?.classList.contains('show') && scopeForm.classList.contains('active'),
        database: databaseForm?.classList.contains('show') && databaseForm.classList.contains('active'),
        selectedreconTargets: window.selectedreconTargets,
        selectedScope: window['selectedScope_recon-'],
        ns_server: params['ns_server']
    });

    if (simpleForm && simpleForm.classList.contains('show') && simpleForm.classList.contains('active')) {
        handlereconSimpleMode(params);
    } else if (scopeForm && scopeForm.classList.contains('show') && scopeForm.classList.contains('active')) {
        handlereconScopeMode(params);
    } else if (databaseForm && databaseForm.classList.contains('show') && databaseForm.classList.contains('active')) {
        handlereconDatabaseMode(params);
    } else {
        console.error('No active tab found');
        return;
    }

    close_reconModalWindow();
}

// Вспомогательные функции для интеграции с другими частями системы
window.recon_script_modal_to_node = function(ip) {
    show_reconModalWindow();
    const inputrecon = document.getElementById('reconinput');
    if (inputrecon && ip) {
        inputrecon.value = ip;
    }
}

window.recon_script_modal_to_info_tabs = async function(rows) {
    show_reconModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    // Получаем уникальные непустые домены
    const uniquerecons = [...new Set(rows
        .map(row => {
            // Предпочитаем домен, если есть, иначе IP
            return row.domain ? row.domain.trim() : (row.ipaddr ? row.ipaddr.trim() : '');
        })
        .filter(target => target !== '')
    )];
    
    console.log('Unique recons to process:', uniquerecons);
    
    // Сбрасываем форму
    const container = document.getElementById('reconInputContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    const originalInput = document.getElementById('reconinput');
    if (originalInput) {
        originalInput.value = '';
    }
    
    // Заполняем поля ввода
    for (let i = 0; i < uniquerecons.length; i++) {
        if (i === 0) {
            // Первый домен в основное поле
            const firstInput = document.getElementById('reconinput');
            if (firstInput) {
                firstInput.value = uniquerecons[i];
            }
        } else {
            // Остальные домены в дополнительные поля
            addNewInputForm('recon');
            
            // Ждем обновления DOM
            await new Promise(resolve => setTimeout(resolve, 50));
            
            // Находим все input'ы и заполняем последний
            const allInputs = document.querySelectorAll('[id^="reconinput"]');
            const lastInput = allInputs[allInputs.length - 1];
            if (lastInput) {
                lastInput.value = uniquerecons[i];
            }
        }
    }
}

// Функция для запуска recon задачи из database вкладки (аналогично info tabs)
window.recon_script_modal_to_database = async function(rows) {
    show_reconModalWindow();
    
    // Ждем пока modal полностью откроется
    await new Promise(resolve => setTimeout(resolve, 150));
    
    // Переключаемся на database вкладку
    const databaseTab = document.getElementById('recon-database-tab');
    if (databaseTab) {
        databaseTab.click();
        
        // Ждем переключения вкладки и инициализации таблицы
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    // Очищаем текущий выбор в таблице
    if (window.reconDatabaseTargetsTable) {
        window.reconDatabaseTargetsTable.deselectRow();
    }
    
    // Выбираем строки в таблице, соответствующие переданным rows
    if (window.reconDatabaseTargetsTable && rows && rows.length > 0) {
        // Получаем текущие данные таблицы
        const tableData = window.reconDatabaseTargetsTable.getData();
        console.log('Table data:', tableData);
        console.log('Rows to select:', rows);
        
        // Создаем массив для выбора строк
        const rowsToSelect = [];
        
        // Ищем соответствующие строки в таблице
        for (const row of rows) {
            const matchingRow = tableData.find(tableRow => {
                // Сравниваем по IP и домену
                const ipMatch = tableRow.ipaddr === row.ip;
                const domainMatch = tableRow.domain === row.domain;
                return ipMatch && domainMatch;
            });
            
            if (matchingRow) {
                rowsToSelect.push(matchingRow);
            }
        }
        
        // Выбираем найденные строки
        if (rowsToSelect.length > 0) {
            window.reconDatabaseTargetsTable.selectRow(rowsToSelect);
            console.log('Selected rows in recon database table:', rowsToSelect.length);
        } else {
            console.warn('No matching rows found in table');
        }
    }
}

// Отладочная информация
console.log('recon tool global functions loaded');
{% endmacro %}

{# Главный макрос recon инструмента #}
{% macro recon_tool_modal() %}
    {% set modal_content = recon_form() %}
    {% set global_functions = recon_global_functions() %}
    
    {{ base_modal(
        modal_id='reconModalWindow',
        modal_title='Recon Tool',
        help_url='https://help.setezor.net/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B.html#recon',
        header_bar=tools_header_bar(prefix='recon_'),
        content=modal_content,
        reset_function='resetreconModal',
        custom_scripts=global_functions
    ) }}
{% endmacro %}