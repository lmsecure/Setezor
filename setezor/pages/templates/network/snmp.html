{% macro snmp_main() %}



<!--  style="-moz-appearance: textfield;" -->

<div id="v-pills-snmp">
    <div id="snmp" class="row">

            <form onsubmit=startScan161udpPort(event) name="SnmpFormName" id="SnmpForm">

                    <div id="snmpInputContainer"></div>

                    <div class="dropdown w-100 mt-2">
                        <button class="btn btn dropdown-toggle w-100" style="--bs-btn-border-color:#d4d9de; --bs-btn-hover-border-color: #d4d9de; --bs-btn-active-border-color: #d4d9de"
                         type="button" id="snmpIpPortDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="Select target">
                          
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="dropdownMenuButton1" id="dropdownMenuForIpPortData">
                        </ul>
                    </div>

                        <label class="mt-3" for="" data-i18n="Community strings dictionary (default if empty):"></label>
                    <form id='idChoiceDictCommunityStrings' name="ChoiceDictCommunityStringsFormName">
                        <div class="mb-3">
                                <input class="form-control me-3" type="file" accept=".txt" id="fileFromSNMPbrute_cs">
                        </div>
                    </form>
                    <div class="btn-group d-flex my-2" role="group">
                        <button class="btn btn-danger w-50" type="button" onclick="reset_community_string_lst()" data-i18n="Reset"></button>
                        <button class="btn btn-primary w-50" type="button" onclick="startScan()" data-i18n="Start"></button>
                    </div>
            </form>
    </div>
</div>

<script>
    function reset_community_string_lst() {
        document.getElementById("fileFromSNMPbrute_cs").value = "";
    }

    async function startScan() {
        let target_ip = selectedIp;
        let target_port = selectedPort;
        let files = document.getElementById('fileFromSNMPbrute_cs').files;
        let agent_id = agentData?.default_agent;

        let community_strings_file = "";
        if (files.length) {
            const file = files[0];
            const reader = new FileReader();
            const content = await new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            community_strings_file = content;
        }

        const payload = {
            community_strings_file,
            target_ip,
            target_port,
            agent_id
        };

        const result = await window.executeToolTasks({
            tasks: [{
                endpoint: '/api/v1/task/snmp_brute_communitystring_task',
                payload
            }],
            stopOnFirstFailure: true
        });

        if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('snmpModalWindow'));
            if (modal) modal.hide();
        } else if (result.reason !== 'module_install_requested') {
            console.error('SNMP scan failed:', result.error);
        }
    }

    let selectedIp = '';
    let selectedPort = '';
    function get_snmp_ip_port_list() {
    axios.get('/api/v1/l4/get_resources_for_snmp').then(resp => {
        const dropdownMenu = document.getElementById('dropdownMenuForIpPortData');
        const dropdownButton = document.getElementById('snmpIpPortDropdown');

        dropdownMenu.innerHTML = '';

        resp.data.forEach((item, index) => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.classList.add('dropdown-item');
            a.href = '#';
            a.textContent = `${item.ip}:${item.port}`;

            a.addEventListener('click', () => {
                dropdownButton.textContent = `${item.ip}:${item.port}`;
                selectedIp = item.ip;
                selectedPort = item.port;
            });

            li.appendChild(a);
            dropdownMenu.appendChild(li);
        });
    })
}

    get_snmp_ip_port_list();

</script>
{% endmacro %}


{% macro snmp_full_script_modal() %}

<div id="snmpModalWindow" class="modal fade" tabindex="-1" aria-labelledby="snmpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="snmpModalLabel">Snmp</h5>
                <a href="https://help.setezor.net/%D0%98%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D1%8B.html#snmp" target="_blank" style="margin-top: 0.3rem; margin-left: 0.2rem;">
                    <i class="bi bi-question-circle fs-4" style="font-family: 'Times New Roman', Times, serif"></i>
                </a>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-2" id="agent_interface_bar_snmp">
                    <div data-agent-bar="agent_snmp"></div>
                    <div data-interface-bar="interface_snmp" class="ms-3"></div>
                    <div id="scans_bar_snmp" class="ms-3"></div>
                </div>
                <div class="d-flex flex-column">
                    <div class="tab-content" id="dsa" style="padding-top: 7px;">
                        {{ snmp_main() }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function snmp_full_modal_window() {
        var myModal = new bootstrap.Modal(document.getElementById('snmpModalWindow'));
        myModal.show();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const myModal = new bootstrap.Modal(document.getElementById('snmpModalWindow'), {
            keyboard: false
        });

        document.querySelector(".btn-close").onclick = function () {
            myModal.hide();
        };

        window.onclick = function (event) {
            if (event.target === document.getElementById("snmpModalWindow")) {
                myModal.hide();
            }
        };
    });
</script>

{% endmacro %}

{% macro snmp_start_with_prefill() %}
<script>
function snmp_start_with_prefill(rows, prefillParams) {
    const modalEl = document.getElementById('snmpModalWindow');
    if (!modalEl) {
        console.error('SNMP modal not found');
        return;
    }

    const originalDefaultAgent = window.agentData?.default_agent;

    if (prefillParams?.agent_id && window.agentData) {
        window.agentData.default_agent = prefillParams.agent_id;
    }

    const myModal = new bootstrap.Modal(modalEl);
    
    const handleShown = () => {
        modalEl.removeEventListener('shown.bs.modal', handleShown);

        if (prefillParams?.target_ip && prefillParams?.target_port) {
            const targetText = `${prefillParams.target_ip}:${prefillParams.target_port}`;
            const dropdownItems = modalEl.querySelectorAll('#dropdownMenuForIpPortData .dropdown-item');
            let found = false;

            for (const item of dropdownItems) {
                if (item.textContent.trim() === targetText) {
                    item.click();
                    found = true;
                    break;
                }
            }

            if (!found) {
                console.warn('SNMP target not found in dropdown:', targetText);
            }
        }

        const fileInput = document.getElementById('fileFromSNMPbrute_cs');
        if (fileInput) fileInput.value = '';
    };

    modalEl.addEventListener('shown.bs.modal', handleShown);

    const handleHidden = () => {
        if (originalDefaultAgent !== undefined && window.agentData) {
            window.agentData.default_agent = originalDefaultAgent;
        }
        modalEl.removeEventListener('hidden.bs.modal', handleHidden);
    };
    modalEl.addEventListener('hidden.bs.modal', handleHidden);

    myModal.show();
}
</script>
{% endmacro %}

{% macro show() %}

{{ snmp_main() }}

{% endmacro %}