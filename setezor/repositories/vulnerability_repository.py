from typing import List

from sqlalchemy import func
from sqlalchemy.orm import aliased
from sqlmodel import SQLModel, or_, select

from setezor.models import DNS, Domain, IP, L4Software, L4SoftwareVulnerability, Port, Vulnerability
from setezor.repositories import SQLAlchemyRepository


class VulnerabilityRepository(SQLAlchemyRepository[Vulnerability]):
    model = Vulnerability

    async def exists(self, mac_obj: SQLModel):
        return False

    async def get_vulnerabilities(self, project_id: str, scans: List[str], limit: int | None = None):
        """Запрос на получение самых распространенных значений в колонке."""

        # Создаем alias для COALESCE
        vulnerabilities_alias = aliased(Vulnerability)

        query = (
            select(
                Vulnerability.name,
                Vulnerability.cve,
                Vulnerability.description,
                func.coalesce(Vulnerability.cvss4_score, Vulnerability.cvss3_score, Vulnerability.cvss2_score).label('cvss_score')
            )
            .filter(self.model.project_id == project_id)
            .where(
                Vulnerability.project_id == project_id,
                func.coalesce(Vulnerability.cvss4_score, Vulnerability.cvss3_score, Vulnerability.cvss2_score).isnot(None)
            )
            .order_by(func.coalesce(Vulnerability.cvss4_score, Vulnerability.cvss3_score, Vulnerability.cvss2_score).desc())
        )

        addition = [self.model.scan_id == scan_id for scan_id in scans]
        query = query.filter(or_(*addition))
        software_version_cpe = await self._session.exec(query)
        return software_version_cpe.fetchall()

    async def get_count_vulns_by_port_ids(self, project_id: str, scans: List[str], port_ids: list[str]):

        stmt = select(
                Port.id,
                IP.ip,
                Port.port,
                Domain.domain,
                func.count(L4SoftwareVulnerability.id).label('cnt')).select_from(Port)\
            .join(IP, IP.id == Port.ip_id, isouter=True)\
            .join(L4Software, L4Software.l4_id == Port.id, isouter=True)\
            .join(DNS, DNS.id == L4Software.dns_id, isouter=True)\
            .join(Domain, Domain.id == DNS.target_domain_id, isouter=True)\
            .join(L4SoftwareVulnerability, L4SoftwareVulnerability.l4_software_id == L4Software.id, isouter=True)\
            .filter(Port.project_id == project_id, Port.id.in_(port_ids), Port.scan_id.in_(scans))\
            .group_by(Port.id, IP.ip, Port.port, Domain.domain)
        result = await self._session.exec(stmt)
        rows = result.all()

        result = {}
        for row in rows:
            result[row[0]] = row[4]

        return result
